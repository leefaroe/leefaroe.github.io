https://www.chartjs.org/docs/latest/<br>
https://quickchart.io/
<!DOCTYPE HTML>
<html>
<head>
    <base target="_top">


    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD&#43;dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.3/dist/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>

    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.bundle.min.js" integrity="sha384-xrRywqdh3PHs8keKZN+8zzc5TX0GRTLCcmivcbNJWm2rs5C8PRhcEn3czEjhAO9o" crossorigin="anonymous"></script>

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/js/bootstrap-datepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datepicker/1.4.1/css/bootstrap-datepicker3.css"/>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>


    <link href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/3.2.0/css/buttons.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/datetime/1.5.4/css/dataTables.dateTime.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedcolumns/5.0.4/css/fixedColumns.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/fixedheader/4.0.1/css/fixedHeader.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/keytable/2.12.1/css/keyTable.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/rowgroup/1.5.1/css/rowGroup.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/searchbuilder/1.8.1/css/searchBuilder.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/searchpanes/2.3.3/css/searchPanes.bootstrap4.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/select/2.1.0/css/select.bootstrap4.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.2.0/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/datetime/1.5.4/js/dataTables.dateTime.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/5.0.4/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/4.0.1/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.datatables.net/keytable/2.12.1/js/dataTables.keyTable.min.js"></script>
    <script src="https://cdn.datatables.net/rowgroup/1.5.1/js/dataTables.rowGroup.min.js"></script>
    <script src="https://cdn.datatables.net/searchbuilder/1.8.1/js/dataTables.searchBuilder.min.js"></script>
    <script src="https://cdn.datatables.net/searchbuilder/1.8.1/js/searchBuilder.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/dataTables.searchPanes.min.js"></script>
    <script src="https://cdn.datatables.net/searchpanes/2.3.3/js/searchPanes.bootstrap4.min.js"></script>
    <script src="https://cdn.datatables.net/select/2.1.0/js/dataTables.select.min.js"></script>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.0.1/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <style type="text/css">
        :root {
            --myBackground: #17a2b8; /*#2A88AD;*/
            --myHighlight: #2AAD8C;
            --white: #faf0e6;
        }

        /*
                .dtrg-level-0{
                    font-size: 8px!important;
                }
        */
        .nav_menu {
            //height: 50px;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2;
        }
        .mynavbar {
            width: 100%;
        }

        .mynavbarselected {
            background: var(--dark);
        }
        .colBorderLeft {
            border-left: 1px solid rgb(128, 128, 128);
        }
        .amount {
            text-align: right
        }
        .sectionHeader{
            text-align: left;
            font-size:1.5rem;
            font-weight: 700!important;
        }
        .number {
            text-align: right
        }

        .chart-containerX {
            display: flex;
            justify-content: center;
        //text-align:center;
            height: 100%;
        }

        .projectSelected {
        }

        a:-webkit-any-link {
            text-decoration: underline;
            text-decoration-line: underline;
        }

        @keyframes ldio-hz3qtxb48e {
            0% {
                opacity: 1
            }
            100% {
                opacity: 0
            }
        }

        .ldio-hz3qtxb48e div {
            left: 94px;
            top: 48px;
            position: absolute;
            animation: ldio-hz3qtxb48e linear 1s infinite;
            background: #ffffff;
            width: 12px;
            height: 24px;
            border-radius: 4.8px / 4.8px;
            transform-origin: 6px 52px;
        }

        .ldio-hz3qtxb48e div:nth-child(1) {
            transform: rotate(0deg);
            animation-delay: -0.9166666666666666s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(2) {
            transform: rotate(30deg);
            animation-delay: -0.8333333333333334s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(3) {
            transform: rotate(60deg);
            animation-delay: -0.75s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(4) {
            transform: rotate(90deg);
            animation-delay: -0.6666666666666666s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(5) {
            transform: rotate(120deg);
            animation-delay: -0.5833333333333334s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(6) {
            transform: rotate(150deg);
            animation-delay: -0.5s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(7) {
            transform: rotate(180deg);
            animation-delay: -0.4166666666666667s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(8) {
            transform: rotate(210deg);
            animation-delay: -0.3333333333333333s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(9) {
            transform: rotate(240deg);
            animation-delay: -0.25s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(10) {
            transform: rotate(270deg);
            animation-delay: -0.16666666666666666s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(11) {
            transform: rotate(300deg);
            animation-delay: -0.08333333333333333s;
            background: #ffffff;
        }

        .ldio-hz3qtxb48e div:nth-child(12) {
            transform: rotate(330deg);
            animation-delay: 0s;
            background: #ffffff;
        }

        .loadingio-spinner-spinner-8akhmpb2pnp {
            width: 200px;
            height: 200px;
            display: inline-block;
            overflow: hidden;
            background: #2a88ad;
        }

        .ldio-hz3qtxb48e {
            width: 100%;
            height: 100%;
            position: relative;
            transform: translateZ(0) scale(1);
            backface-visibility: hidden;
            transform-origin: 0 0; /* see note above */
        }

        .ldio-hz3qtxb48e div {
            box-sizing: content-box;
        }

        /* generated by https://loading.io/ */
        #inProgress {
            text-align: center;
            font-size: 20px;
            width: 500px;
            height: 400px;
            padding: 30px;
            background: #2A88AD;
            color: #fff;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
            -moz-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
            -webkit-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
        }

        .center-block {
            top: 50%;
            left: 50%;
            transform: translate3d(-50%, -50%, 0);
            position: absolute;
        }

        .spinner {
            position: absolute;
            left: 42%;
            top: 35%;
        }

        /* Position to place the spinner  */
        .control-label {
            color: var(--myBackground);
        }

        h1{
            -webkit-border-radius: 10px 10px 10px 10px;
            text-align: center;
        }
        h2 {
            -webkit-border-radius: 10px 10px 10px 10px;
            text-align: left;
        }

        h4 {
            -webkit-border-radius: 10px 10px 10px 10px;
        }

        .mySection {
            padding: 10px;
            background: #FFF;
            border-radius: 20px;
            -webkit-border-radius: 20px;
            -moz-border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
            -moz-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
            -webkit-box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.13);
        }

        td {
            padding-right: 30px;
        }

        .popover {
            max-width: 900px !important;
            white-space: pre-line;
        }

        .popover-title {
            background: #ffff99;
        }

        .popover-header {
            background: var(--primary);
            color: black;
        }

        .bg-readonly {
            background-color: #ced4da !important;
        }

        input[type="checkbox"][readonly][checked] {
            outline: 1px solid var(--primary);
        }

        :checked + label {
            font-weight: bold;
        }

        .checkbox-wrapper {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
        / / grid-template-rows: repeat(2, 1 fr);
        }

        .required-indicator {
            color: red;
        }

        .msgHeader {
            padding: 10px;
            margin: 5px;
            background: #FFF;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
        }

        .rounded20 {
            border-radius: 1rem !important;
        }

        .smaller90 {
            font-size: .9em;
        }

        .completed {
            background: #93d3a2 !important;
        }

        .myblue {
            background: #99c3ef !important;
        }

        /* Place the navbar at the bottom of the page, and make it stick */
        .custnavbar {
            overflow: hidden;
            position: fixed;
            //bottom: 0;
            top:100;
            left: 0px;
            background-color: #007bff;
            color: #fff;
            margin: 25px 5px 10px 10px; //top,right,bottom,left
            border-radius: 10px 10px 0 0;
            -webkit-border-radius: 10px 10px 0 0;
            -moz-border-radius: 10px 10px 0 0;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.12);
            font-size: 20px;
            box-shadow: 1px 1px 4px #DADADA;
            -moz-box-shadow: 1px 1px 4px #DADADA;
            -webkit-box-shadow: 1px 1px 4px #DADADA;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            text-align: center;
            max-width:125px
        }

        /* Style the links inside the navigation bar */
        .btn-group-xs > .btn, .btn-xs {
            padding: .25rem .4rem;
            font-size: .875rem;
            line-height: .5;
            border-radius: .2rem;
        }
    </style>

    <script>
        var startTime = new Date(), functionStartTime = new Date(), elapsedA = ['HH:MM:SS.ms']

        function elapsedTimeTest() {
            console.log(elapsedTime(new Date, 'test'))
            console.log(elapsedA.join('\n'))
        }

        function elapsedTime(s, pref, printArray=0) {
            var endTime = new Date();


            var ms = endTime - s;
            var f = ms2Time(ms)
            var x = ' ELAPSED TIME ' + s + ' ' + f + ' ' + pref
            elapsedA.push(f + ' ' + pref)
            if (printArray) {
                console.log('*** ELAPSED TIME ***\n' + elapsedA.join('\n'))
            } else {
                console.log(x)
            }
            startTime = new Date();
            return x;
        }

        function ms2Time(ms) {
            var secs = ms / 1000;
            ms = Math.floor(ms % 1000);
            var minutes = secs / 60;
            secs = Math.floor(secs % 60);
            var hours = minutes / 60;
            minutes = Math.floor(minutes % 60);
            hours = Math.floor(hours % 24);
            return padLeft(hours, 2) + ":" + padLeft(minutes, 2) + ":" + padLeft(secs, 2) + "." + padLeft(ms, 5);
        }

        function padLeft(num, size, padChar='0') {
            num = num.toString();
            while (num.length < size) num = padChar + num;
            return num;
        }
    </script>
    <script>
        //moment.load()
        Chart.register(ChartDataLabels);
        var debug = 'Y' , collapsedGroups = {},months_YYYY_MM=[] ,months_MMM_YYYY=[],changesMade=false,totalsRow=['',''],production=0
        var allProjectData = {
            "rows": [["Project", "Current Profit %", "Forecasted Profit %", "Forecasted Profit $", "% Billed", "Total Contract $", "Billed to Date $", "URL"],
                ["999901 - Test Project 1", 0.3711651520387299, 0.423073, 67691.68, 0.99971875, 160000, 159955, "https://docs.google.com/spreadsheets/d/1rTUqlzJ_vmWmD9O4rpgn1W2OsMDI3xoNVHFjzzFbav4/edit"],
                ["999902 - Test Project 2", 0.4375952595520881, 0.6413115662650603, 106457.72, 0.6626506024096386, 166000, 110000, "https://docs.google.com/spreadsheets/d/1gRqg7k5ABPZr2jQkRBgxcpeTJRcN7WeCyjG37o_0sq0/edit"],
//                ["202411 - DBK PM Ops", 0.5144003, 0.5593551, 55935.51, 1, 100000, 100000, "https://docs.google.com/spreadsheets/d/1d_fLb0cq7AauTQD4VQAxXXVwwmKATBfmBiWvWjkJcX8/edit"],
                //              ["202413 - HCC OpEx & ERP", 0.5555621061601893, 0.47145727777777774, 84862.31, 0.8055555555555556, 180000, 145000, "https://docs.google.com/spreadsheets/d/1tJR6deHnXJot3LPsHGPqw6pduVD8zTLm7W7uwNJ6DbU/edit"],
                ["999902 - Test Project 2", 0.4839580040481326, 0.5038863414634146, 30989.01, 1, 61500, 61500, "https://docs.google.com/spreadsheets/d/1cKrJqBzUS6LFBhm-rqj1A5qKdVrQYbMGNBf_EZa-xoU/edit"],
                //            ["202416 - Argus Eyed OPEX", 0.6665745405335008, 0.6231530526315789, 59199.54, 1, 95000, 95000, "https://docs.google.com/spreadsheets/d/16rDNONYnEyLrrEOuEUQ6sJTMFo_-kqCmhjYtdzczViE/edit"],
                //          ["202417 - Janke OpEx", 0.4733880838313996, 0.5116170666666666, 76742.56, 0.9666666666666667, 150000, 145000, "https://docs.google.com/spreadsheets/d/1tufiA-FgCmDec2wCbKKkyuWNnw11-PyBOLbiiTlgytE/edit"],
                //        ["202420 - Midstates ERP", 0.5507327473357032, 0.4824724736842105, 45834.884999999995, 0.9263157894736842, 95000, 88000, "https://docs.google.com/spreadsheets/d/1E1sDa0xtfpsAJ-SD6BOk6dLb8iW2NNVWQAU3IeQY_jQ/edit"],
                //      ["202421 - Power Plumbing - Supply Chain", 0.4828703541902781, 0.5350086363636364, 58850.950000000004, 0.9090909090909091, 110000, 100000, "https://docs.google.com/spreadsheets/d/11nPKXOHlgN_5gp7j-X61QSC1b7HkoRf7bzSsI3_ha50/edit"]
            ],
            "Projects": {
                "999901 - Test Project 1": {
                    "Name": "999901 - Test Project 1",
                    "Row": ["999901 - Test Project 1", 0.3711651520387299, 0.423073, 67691.68, 0.99971875, 160000, 159955, "https://docs.google.com/spreadsheets/d/1rTUqlzJ_vmWmD9O4rpgn1W2OsMDI3xoNVHFjzzFbav4/edit"],
                    "QboId": 616
                },
                "999902 - Test Project 2": {
                    "Name": "999902 - Test Project 2",
                    "Row": ["999902 - Test Project 2", 0.3711651520387299, 0.423073, 67691.68, 0.99971875, 160000, 159955, "https://docs.google.com/spreadsheets/d/1rTUqlzJ_vmWmD9O4rpgn1W2OsMDI3xoNVHFjzzFbav4/edit"],
                    "QboId": 616
                },
                "999903 - Test Project 3": {
                    "Name": "999903 - Test Project 3",
                    "Row": ["999903 - Test Project 3", 0.3711651520387299, 0.423073, 67691.68, 0.99971875, 160000, 159955, "https://docs.google.com/spreadsheets/d/1rTUqlzJ_vmWmD9O4rpgn1W2OsMDI3xoNVHFjzzFbav4/edit"],
                    "QboId": 616
                },
            },
            'Cost Codes': [["Code", "Product/Service Name"], [1, "Discovery"], [2, "Process Mapping"], [3, "Implementation Plan"], [4, "ERP Selection"], [5, "Job Descriptions"], [6, "Project Administration"], [7, "General & Misc. Consulting"], [8, "Documentation"], [9, "Closeout"], [10, "ERP Implementation"], [11, "Travel"], [12, "Training"], [13, "Data Entry"], [14, "System Configuration"], [15, "Incentive Compensation"], [16, "System Audit"], [17, "Quality Assurance"], [18, "Web Design"], [19, "Podcast"], [20, "Video Editing"], [21, "Strategy Development"], [22, "Content Creation"], [23, "Advertising"], [24, "Social Media"], [25, "Data Analysis"], [26, "Contingency"], [99, "Ascent Internal"]]
        }
        var projectData = {IncomeTotal:16050.3,ExpenseTotal:4957+1031.67,ProjectName:'999999 - Test Project',StartDate:'2024-01-01',EndDate:'2025-04-11',
            'Income': {
                '    Billable Expense Income': 865.38,
                '    Procore Revenue': 15000,
                '    Sales - COGS': 184.92,
                'Total': 16050.3
            },

            'Contracts': {
                '2024-10-10': 20000,
                'Total': 20000
            },
            'Cost of Goods Sold': {
                '    Cost of Goods Sold': 0,
                '        Travel - Client': 0,
                '            Hotels': 566.38,
                '        Total Travel - Client': 566.38,
                '        Travel - Client Meals': 166.29,
                '    Total Cost of Goods Sold': 732.67,
                '    Other Costs - COS': 0,
                '        QuickBooks Payments Fees': 299,
                '    Total Other Costs - COS': 299,
                'Total Cost of Goods Sold': 1031.67
            },

            'Expenses': {
                '    Operating Expenses': 0,
                '        Office Expenses': 32,
                '    Total Operating Expenses': 32,
                '    Employee Cost': 4925,
                'Total Expenses': 4957
            },

            'Invoices':{Tab:'Dashboard', Format:["Date","String","Amount"],"DataCol":2,
                Headers:0,
                CreateChart:1,
                "rows":[["2024-12-20","Due in 15 days (2025-01-04)",2000],["2024-11-07","Paid",5000],["2024-10-11","Paid",10000],["Total","",20000]],"Paid":16050.3,"UnPaid":5000,"Remaining":3000},
            'Employee Cost': {
                Tab:'Dashboard', Format:['String','Number','Amount','Amount','Percent','Percent'],
                "DataCol": 4,
                Headers:1,
                CreateChart:1,
                "rows": [["Employee", "Hours", "Total $", "Using Project Rate $  ", "% of Total Hours", "% of Total $"],
                    ["Amy Smith", 7.5, 675, 675, 0.18072289156626506, 0.13705583756345177], ["Greg G", 2.5, 312.5, 312.5, 0.060240963855421686, 0.06345177664974619], ["Kevin Jones", 31.5, 3937.5, 3937.5, 0.7590361445783133, 0.799492385786802], ["Total:", 41.5, 4925, 4925, "", ""]]
            },
            'Forecast Summary': {
                Tab:'Dashboard', Format: ["String", "Skip","Skip","Amount","Skip", "Amount"],
                "DataCol": 0,
                Headers:0,
                CreateChart:0,
                "rows": [["Contract Value", "", "", 20000, "", ""],
                    ["Forecasted Labor", "", "", 5285, "", 0.26425],
                    ["Forecasted Non-Reimbursable", "", "", 465.28999999999996, "", 0.023264499999999997],
                    ["Forecasted Subcontractor", "", "", 0, "", 0], ["Forecasted Gross Profit", "", "", 14249.71, "", ""],
                    ["Forecasted Profit %", "", "", 0.7124855, "", ""]]
            },
            'Employee Cost by Service': {
                "Headers": 1,
                "CreateChart": 0,
                Tab:'Labor', Format: ["String", "String", "Number", "Amount"],
                "DataCol": 2,
                "rows": [["Employee", "Service", "Hours", "Total $"], ["Amy Smith", "01 - Discovery", 3, 270], ["", "06 - Project Administration", 3, 270], ["", "07 - General & Misc. Consulting", 1.5, 135], ["Greg G", "01 - Discovery", 1, 125], ["", "06 - Project Administration", 1.5, 187.5], ["Kevin Jones", "01 - Discovery", 9, 1125], ["", "06 - Project Administration", 5.5, 687.5], ["", "11 - Travel", 8, 1000], ["", "12 - Training", 9, 1125], ["Total", "", 41.5, 4925]]
            },
            'Labor': {
                "Headers": 1,
                "CreateChart": 1,
                Tab:'Labor', Format: ["String", "Number", "Amount", "Percent", "Percent"],
                "DataCol": 2,
                "rows": [["Service", "Hours", "Total $", "% of Total Hours", "% of Total $"], ["01 - Discovery", 13, 1520, 0.3132530120481928, 0.3086294416243655], ["06 - Project Administration", 10, 1145, 0.24096385542168675, 0.23248730964467004], ["07 - General & Misc. Consulting", 1.5, 135, 0.03614457831325301, 0.027411167512690356], ["11 - Travel", 8, 1000, 0.1927710843373494, 0.20304568527918782], ["12 - Training", 9, 1125, 0.21686746987951808, 0.22842639593908629],
                    ["Total", 41.5, 4925, "", ""]]
            },
            'Time Data': {
                Tab: 'TimeData',
                "Headers": 1,
                "CreateChart": 0,
                "Format": ["String", "String", "String", "String", "Number", "Amount", "Amount"],
                "rows": [
                    //["Employee", "Activity Date", "Product/Service", "Memo/Description", "Duration", "Cost Rate", "Cost"],
                    ["Amy Smith", "2024-11-15T05:00:00.000Z", "07 - General & Misc. Consulting", "Troubleshooting re: Job costs not syncing properly through ERP connector", 1.5, 90, 135],
                    ["Amy Smith", "2024-11-01T04:00:00.000Z", "06 - Project Administration", "Review of onsite w/ Kevin & update on anticipated remaining work", 0.5, 90, 45], ["Kevin Jones", "2024-11-01T04:00:00.000Z", "06 - Project Administration", "Handoff with Aimee", 1, 125, 125],
                    ["Kevin Jones", "2024-11-01T04:00:00.000Z", "11 - Travel", "Travel", 4, 125, 500],
                    ["Kevin Jones", "2024-10-31T04:00:00.000Z", "12 - Training", "Training", 9, 125, 1125],
                    ["Kevin Jones", "2024-10-30T04:00:00.000Z", "01 - Discovery", "Discovery", 9, 125, 1125],
                    ["Amy Smith", "2024-10-29T04:00:00.000Z", "06 - Project Administration", "Followup & resolve client question regarding NDA (client accepted our NDA as sufficient)", 0.5, 90, 45],
                    ["Kevin Jones", "2024-10-29T04:00:00.000Z", "11 - Travel", "Travel", 4, 125, 500],
                    ["Amy Smith", "2024-10-24T04:00:00.000Z", "06 - Project Administration", "Follow up w/ client regarding NDA question - transmitted signed copy of NDA on file & awaiting response.", 0.5, 90, 45],
                    ["Kevin Jones", "2024-10-24T04:00:00.000Z", "06 - Project Administration", "Building Agenda", 1, 125, 125],
                    ["Kevin Jones", "2024-10-24T04:00:00.000Z", "06 - Project Administration", "Project Kickoff", 1, 125, 125], ["Amy Smith", "2024-10-23T04:00:00.000Z", "01 - Discovery", "Client kickoff meeting", 0.5, 90, 45],
                    ["Greg G", "2024-10-23T04:00:00.000Z", "01 - Discovery", "1. Client kickoff meeting. \n2. Project admin and budget research.", 1, 125, 125],
                    ["Amy Smith", "2024-10-23T04:00:00.000Z", "06 - Project Administration", "Internal team meeting to discuss project strategy (onsite & continued support)", 1, 90, 90],
                    ["Kevin Jones", "2024-10-23T04:00:00.000Z", "06 - Project Administration", "Prep Work", 2, 125, 250],
                    ["Amy Smith", "2024-10-22T04:00:00.000Z", "01 - Discovery", "Explore current client Procore configuration prior to kickoff on Wednesday; look into Agenda", 2.5, 90, 225],
                    ["Amy Smith", "2024-10-16T04:00:00.000Z", "06 - Project Administration", "Internal project kickoff meeting (Greg & Kevin)", 0.5, 90, 45],
                    ["Greg G", "2024-10-16T04:00:00.000Z", "06 - Project Administration", "1. Internal team kickoff meeting.", 0.5, 125, 62.5],
                    ["Kevin Jones", "2024-10-16T04:00:00.000Z", "06 - Project Administration", "Internal Kickoff", 0.5, 125, 62.5],
                    ["Greg G", "2024-10-15T04:00:00.000Z", "06 - Project Administration", "1. Kickoff meeting setup.\n2. Kickoff emails to the client.", 0.5, 125, 62.5],
                    ["Greg G", "2024-10-11T04:00:00.000Z", "06 - Project Administration", "1. Project setup and folder structure.\n2. Contract review/NDA. \n3. Emails to the client.", 0.5, 125, 62.5]

                ]
            },
            'Project Team':{
                "Adam Levine": 150,
                "Amy Smith": 90,
                "Greg G": 125,
                "Kevin Jones": 125,
                "Jack Smith": 60,
                "John Jones": 60,
                "Sam Smith": 90,
                "Kristen Bell": 80,
                "Ray Jackson":60,
                "Leefa Roe":75,
                "Patty Smith":60,
            },
            'Budget': {
                "11": {"Adam Levine": {"2024-02": 5}, "Patty Smith": {"2024-02": 5}},
                "17": {
                    "Patty Smith": {
                        "2024-03": 2,
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2
                    },
                    "Kristen Bell": {
                        "2024-05": 1,
                        "2024-06": 1,
                        "2024-07": 1,
                        "2024-08": 1,
                        "2024-09": 1,
                        "2025-01": 2,
                        "2025-02": 2
                    },
                    "Ray Jackson": {
                        "2024-03": 2,
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2
                    },
                    "Adam Levine": {"2024-03": 1, "2024-04": 1, "2024-05": 1, "2024-06": 1, "2024-07": 1}
                },
                "18": {
                    "Kristen Bell": {"2024-06": 1, "2024-07": 1, "2024-08": 1, "2024-09": 1, "2024-10": 1},
                    "Ray Jackson": {
                        "2024-03": 5,
                        "2024-04": 5,
                        "2024-05": 5,
                        "2024-06": 5,
                        "2024-07": 5,
                        "2024-08": 5,
                        "2024-09": 5,
                        "2024-10": 5
                    }
                },
                "21": {
                    "Patty Smith": {
                        "2024-03": 1,
                        "2024-04": 1,
                        "2024-05": 1,
                        "2024-06": 1,
                        "2024-07": 1,
                        "2024-08": 1,
                        "2024-09": 1,
                        "2024-10": 1,
                        "2024-11": 1,
                        "2024-12": 1
                    },
                    "Kristen Bell": {
                        "2024-11": 1,
                        "2024-12": 1,
                        "2025-01": 1,
                        "2025-02": 1,
                        "2025-03": 1,
                        "2025-04": 1
                    },
                    "Adam Levine": {"2024-02": 1, "2024-03": 1, "2024-04": 1, "2024-05": 1, "2024-06": 1}
                },
                "22": {
                    "Patty Smith": {
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 1
                    },
                    "Kristen Bell": {"2024-07": 1, "2024-08": 1, "2024-09": 1, "2024-10": 1, "2024-11": 1},
                    "Ray Jackson": {
                        "2024-03": 10,
                        "2024-04": 10,
                        "2024-05": 10,
                        "2024-06": 10,
                        "2024-07": 10,
                        "2024-08": 20,
                        "2024-09": 10,
                        "2024-10": 10,
                        "2024-11": 10,
                        "2024-12": 10,
                        "2025-01": 10,
                        "2025-02": 10
                    }
                },
                "23": {
                    "Ray Jackson": {
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2,
                        "2025-01": 2,
                        "2025-02": 2,
                        "2025-03": 2,
                        "2025-04": 2
                    }
                },
                "24": {
                    "Patty Smith": {
                        "2024-07": 10,
                        "2024-08": 10,
                        "2024-09": 10,
                        "2024-10": 8,
                        "2024-11": 8,
                        "2024-12": 6,
                        "2025-01": 6,
                        "2025-02": 6,
                        "2025-03": 6,
                        "2025-04": 5
                    }, "Kristen Bell": {"2024-07": 1, "2024-08": 1, "2024-09": 1, "2024-10": 1, "2024-11": 1}
                },
                "25": {
                    "Patty Smith": {
                        "2024-05": 1,
                        "2024-06": 1,
                        "2024-07": 1,
                        "2024-08": 1,
                        "2024-09": 1,
                        "2024-10": 1,
                        "2024-11": 1,
                        "2024-12": 1
                    },
                    "Ray Jackson": {
                        "2024-02": 2,
                        "2024-03": 2,
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2,
                        "2025-01": 2,
                        "2025-02": 2,
                        "2025-03": 2,
                        "2025-04": 2
                    },
                },
                "26": {
                    "Kristen Bell": {
                        "2024-11": 1,
                        "2024-12": 1,
                        "2025-01": 1,
                        "2025-02": 1,
                        "2025-03": 1,
                        "2025-04": 1
                    },
                    "Adam Levine": {
                        "2024-11": 1,
                        "2024-12": 1,
                        "2025-01": 1,
                        "2025-02": 1,
                        "2025-03": 1,
                        "2025-04": 1
                    }
                },
                "99": {
                    "Kristen Bell": {
                        "2024-11": 1,
                        "2024-12": 1,
                        "2025-01": 2,
                        "2025-02": 1,
                        "2025-03": 1,
                        "2025-04": 1
                    }
                },
                "01": {"Adam Levine": {"2024-02": 12}, "Patty Smith": {"2024-02": 12}},
                "02": {
                    "Leefa Roe": {
                        "2024-02": 1,
                        "2024-03": 2,
                        "2024-04": 3,
                        "2024-05": 4,
                        "2024-06": 5,
                        "2024-07": 6,
                        "2024-08": 7,
                        "2024-09": 8,
                        "2024-10": 9,
                        "2024-11": 10,
                        "2024-12": 11,
                        "2025-01": 12,
                        "2025-02": 13,
                        "2025-03": 14,
                        "2025-04": 15,
                    },
                    "Patty Smith": {
                        "2024-02": 1,
                        "2024-03": 2,
                        "2024-04": 3,
                        "2024-05": 4,
                        "2024-06": 5,
                        "2024-07": 6,
                        "2024-08": 7,
                        "2024-09": 8,
                        "2024-10": 9,
                        "2024-11": 10,
                        "2024-12": 11,
                        "2025-01": 12,
                        "2025-02": 13,
                        "2025-03": 14,
                        "2025-04": 15,
                    }
                },

                "06": {
                    "Patty Smith": {
                        "2024-02": 2,
                        "2024-03": 2,
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2
                    }
                },
                "07": {
                    "Adam Levine": {
                        "2024-03": 1,
                        "2024-04": 1,
                        "2024-05": 1,
                        "2024-06": 1,
                        "2024-07": 1,
                        "2024-08": 1
                    },
                    "Patty Smith": {
                        "2024-03": 2,
                        "2024-04": 2,
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2,
                        "2025-01": 1,
                        "2025-02": 1,
                        "2025-03": 1,
                        "2025-04": 1
                    },
                    "Ray Jackson": {
                        "2024-03": 1,
                        "2024-04": 1,
                        "2024-05": 1,
                        "2024-06": 1,
                        "2024-07": 1,
                        "2024-08": 1,
                        "2024-09": 1,
                        "2024-10": 1,
                        "2024-11": 1,
                        "2024-12": 1,
                        "2025-01": 1,
                        "2025-02": 1
                    },
                    "Kristen Bell": {
                        "2024-05": 2,
                        "2024-06": 2,
                        "2024-07": 2,
                        "2024-08": 2,
                        "2024-09": 2,
                        "2024-10": 2,
                        "2024-11": 2,
                        "2024-12": 2,
                        "2025-01": 2,
                        "2025-02": 2,
                        "2025-03": 2,
                        "2025-04": 2
                    }
                }
            }
        }
        var userH = {
            "Name": "Ascent Dashboard",
            "Email": "ascentdashboard@ascentconsults.com",
            "Role": "Admin",
            "Pipelines": "",
            "Accountability": "",
            "Daily Email": "N"
        };
        var env = 'dev';
        var title = '*** DEV *** Dashboard';
        var releaseMsg = '';
        var useTestData = 'Y';
        var graphColors=["#27aeef", "#b33dc6","#ea5545", "#87bc45" ,"#f46a9b", "#ef9b20", "#edbf33", "#bdcf32" ]


        var valuesPassed = "{}";
        var today = new Date().toISOString().substring(0, 10), popoverData, interactionById = {}, nextactionById = {},
            currDistEmails, viewCustomerReturn = '',projectTeamDropdown='',costCodeDropdown=''
        var startDate = new Date(), googleDate

        function preventFormSubmit() {
            var forms = document.querySelectorAll('form');
            for (var i = 0; i < forms.length; i++) {
                forms[i].addEventListener('submit', function (event) {
                    event.preventDefault();
                });
            }
        }

        window.addEventListener("load", functionInit, true);

        function allProjectSetup() {
            $('.projectSelected').each(function () {
                var elem = $(this)[0];
                elem.style.display = 'none'
            });
            var colOrder = [['Income', 'Contracts', 'Invoices', 'Forecast Summary'], ['Cost of Goods Sold', 'Expenses', 'Employee Cost']]
            var ht = ''
            var col = ''
            var fmt = ['String', 'Percent', 'Percent', 'Amount', 'Percent', 'Amount', 'Amount', 'String']
            var projectListDIV = document.getElementById('projectListDIV')
            var apd= allProjectData
            var proj = allProjectData.Projects
            var rows=allProjectData.rows
            hc = '<table >\n'
            var cdNotBilled = [], cdBilled = [], coloridx = 0,labels=[] ,cdTotal=[]
            for (var ri = 0; ri < rows.length; ri++) {
                var row = rows[ri]
                var proj = row[0]
                //var h = keys[i]
                hc += '<tr>'

                for (var ci = 0; ci < row.length-1; ci++) {
                    var v = row[ci]
                    var vf = fmt[ci]
                    col = ''
                    if (ri == 0) {
                        col = 'class="font-weight-bold" '
                        vf = 'String'
                        if (ci==0) {
                            col += ' style="width: 35%;"'
                        }
                    } else {
                        if (ci == 5) {
                            var nb=v-row[6]
                            cdTotal.push(v)
                            cdNotBilled.push(nb)
                        } else if (ci == 6) {
                            cdBilled.push(v)
                        } else if (ci == 0) {
                            //v=v.substring(9)
                            var a=v.split(' - ')
                            //v=v.replace(' - ','\n')
                            labels.push(a)
                        }
                    }
                    if (vf == 'Amount' || vf == 'Percent' || vf == 'Number') {
                        col += ' class="number"'
                    }
                    if (ci == 0 && ri>0) {
                        var proj2=proj.replace(' - ','<br>')
                        var x='<td><button type="button" class="btn btn-secondary w-100" onclick="projectPicked(\'' + proj + '\')" >' + proj2 + '</button></td>'
                        hc += x
                    } else {
                        v = formatValue(v, 0, vf)
                        hc += '<td ' + col + '> ' + v + '</td>'
                    }
                    col = ''
                }
                hc += '</tr>\n'
            }


            hc += '				</table>\n'
            var div = document.createElement("div")
            div.innerHTML = hc;
            console.log(hc)
            projectListDIV.append(div)

            console.log('not billed data: '+JSON.stringify(cdNotBilled))
            console.log('billed data: '+JSON.stringify(cdBilled))
            console.log('totaldata: '+JSON.stringify(cdTotal))
            console.log('labels: '+JSON.stringify(labels))
            var config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Contract',
                            backgroundColor: "#27aeef",
                            data: cdTotal,
//                            barThickness: 60,
                        },
                        {
                            label: 'Billed',
                            backgroundColor: '#008000',
                            data: cdBilled,
                        },
                    ],
                },
                options: {
                    indexAxis: 'y',responsive: true,maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                // Include a dollar sign in the ticks
                                callback: function(value, index, ticks) {
                                    return formatValue(value, 0, 'Amount')
                                }
                            }
                        }
                    },
                    layout: {
                        padding: 20
                    },
                    plugins: {
                        legend: {
                            display: true,
                        },
                        datalabels: {
                            formatter: function (value, context) {
                                return formatValue(value, 0, 'Amount')
                            },
                            color: '#000',
                            labels: {
                                title: {
                                    font: {
                                        //weight: 'bold',
                                    },
                                },
                            },
                        },
                    },
                }
            }

            var chartCanvas = document.getElementById('projectListBar').getContext('2d');
            var chart=new Chart(chartCanvas, config);

            var costCodeDropdown = '<option value="">Select One</option>'
            var data = allProjectData['Cost Codes']
            for (var ri = 1; ri < data.length; ri++) {
                var row = data[ri]
                var codeX = row[0]
                var codeF=new Intl.NumberFormat(undefined, {style: 'decimal',maximumFractionDigits: 0,minimumFractionDigits: 0,minimumIntegerDigits:2}).format(codeX)
                var nm = row[1]
                costCodeDropdown += `<option value="${codeF}"> ${codeF}-${nm}</option>`;
            }
            $('.costCodeDropdown').html(costCodeDropdown)
        }

        function projectSetup() {
            var config = {
                type: 'bar',
                data: {
                    labels: ['Income','Expenses','Profit'],
                    datasets: [
                        {
                            indexAxis:'y',barThickness: 24,
                            data: [16050,5989,16050-5989],
                            backgroundColor: ['#008000', '#C70039',"#27aeef"]
                        },
                    ],
                },
                options: {
                    plugins: {
                        legend: {
                            display: false,
                        },
                        datalabels: {
                            anchor: 'begin',
                            align: 'begin',
                            color: 'white',
                            formatter: function (value, context) {
                                return formatValue(value, 0, 'Amount')
                            },
                            font: {
                                size: 12,
                                weight: 'bold',
                            },
                        },
                    },
                },
            }
            var chartStatus = Chart.getChart('dashboardSummary'); // <canvas> id
            if (chartStatus != undefined) {
                chartStatus.destroy();
            }
            var chartCanvas = document.getElementById('dashboardSummary').getContext('2d');
            var chart=new Chart(chartCanvas, config);
            chart.canvas.parentNode.style.height = '200px';
            //chart.canvas.parentNode.style.width = '200px';
            var numItems = $('.dashboardChart').length
            console.log('deleting dashboardcharts:'+numItems)
            $('.dashboardChart').remove(); //remove all canvas itesm from dashboard

            var colOrder=[['Income','Contracts','Invoices','Forecast Summary'],['Cost of Goods Sold','Expenses','Employee Cost','Employee Cost by Service','Labor']]
            var ht='' ,hc=''
            colOrder.forEach(function(colList, index){
                var colNum=index+1
                var dashboardCol1DIV=document.getElementById('dashboardCol'+colNum+'DIV')
                var xb=dashboardCol1DIV.outerHTML
                dashboardCol1DIV.innerHTML=''
                var x=dashboardCol1DIV.outerHTML
                colList.forEach(function(h){
                    var cd=[],coloridx=0
                    //var h = keys[i]
                    var hc='',hNS=h.replaceAll(' ','')
                    hc='<div class="border rounded20" id="dashboard'+h+'">\n'
                    hc+='   <div class="row">\n'
                    hc+='		<div class="col">\n'
                    hc+='				<table  class="display table " id="tb'+hNS+'" style="width:100%">\n'

                    if(h!='Time Data')hc += '<tr><td colspan="9" style="border-bottom: 3pt solid black;"><span class="sectionHeader">'+h+'</span></td></tr>\n'
                    var ent=projectData[h]
                    var createChart=1

                    var tab='Dashboard'
                    if (ent.Format) {
                        tab=ent.Tab
                        if(!ent.CreateChart)createChart=0
                        var rows= ent.rows
                        var fmt=ent.Format
                        for (var j = 0; j < rows.length; j++) {
                            var row=rows[j]
                            var tr='<tr>'
                            var item=row[0]
                            var col=''
                            if (j==0 && ent.Headers) {
                                tr='<tr class="font-weight-bold">'
                            } else if (item.toLowerCase().indexOf('total') < 0) {
                                if (h!='Invoices' && createChart) {
                                    col = 'style="background: ' + graphColors[coloridx] + '"'
                                    coloridx++
                                }
                            } else if (item.toLowerCase().indexOf('total') >= 0) {
                                tr='<tr class="font-weight-bold">'
                            }
                            for (var ci = 0; ci < row.length; ci++) {
                                var v = row[ci]
                                var vf = fmt[ci]
                                if (item.toLowerCase().indexOf('total') < 0 && ci ==ent.DataCol && j>0){
                                    cd.push(v)
                                }
                                if(item=='Forecasted Profit %' && vf=='Amount')vf='Percent'
                                if (vf =='Amount' || vf=='Percent'|| vf=='Number') {
                                    col+=' class="number"'
                                }
                                if(vf!='Skip') {
                                    if(j ==0 && ent.Headers){
                                        vf='String'
                                        tr += '<th> ' + v + '</th>'
                                    } else {
                                        v = formatValue(v, 0, vf)
                                        tr += '<td ' + col + '> ' + v + '</td>'
                                    }
                                }
                                col=''
                            }
                            tr+='</tr>\n'
                            hc+=tr
                        }

                        if (h=='Invoices'){
                            cd = [ent.Paid,ent.UnPaid]
                        }
                    } else {
                        var ikeys = Object.keys(ent)
                        for (var j = 0; j < ikeys.length; j++) {
                            var item = ikeys[j]
                            var itemv = ent[item]
                            if (itemv != 0) {
                                var vf = formatValue(itemv,0,'Amount')

                                var rowStyle='',col=''
                                if (item.toLowerCase().indexOf('total') < 0) {
                                    var col = 'style="background: ' + graphColors[coloridx] + '"'
                                    coloridx++
                                    cd.push(itemv)
                                } else if (item.toLowerCase().indexOf('total') >= 0) {
                                    rowStyle='class="font-weight-bold"'
                                } else {
                                    col = 'class="font-weight-bold"'
                                }
                                hc += '<tr ' + rowStyle+ '><td ' + col + '>' + item.replaceAll(' ', '&nbsp;') + '</td><td class="number">' + vf + '</td></tr>\n'
                            }
                        }
                    }
                    hc+='				</table>\n'
                    hc+='		</div><!--end after table DIV-->\n'
                    if (createChart || tab=='Labor') {
                        hc += '		<div class="col-3">\n'
                        //hc+='				<div class="chart-container" style="position: relative; height:20vh; width:20vw">\n'
                        hc += '				<div class="chart-container" style="display:block;margin:0 auto;">\n'
                        hc += '						<canvas id="donut' + h + '" class="dashboardChart" style="width:128px;height:128px"></canvas>\n'
                        hc += '				</div>\n'
                        hc += '		</div>\n'
                    }
                    hc+='   </div><!--end row-->\n'
                    hc+='</div><!--end dashboard'+h+' DIV-->'

                    if (h == 'Invoices') {
                        var config = {
                            type: 'doughnut',
                            options: {responsive: false,},
                            data: {datasets: [{data: cd, backgroundColor: ['#008000', '#C70039'],}],},
                        };
                    } else {
                        var config = {
                            type: 'doughnut',
                            options: {responsive: false,},
                            data: {datasets: [{data: cd, backgroundColor: graphColors,}],},
                        };
                    }
                    if (ent.Format) {
                        var dataColFormat = ent.Format[ent.DataCol]
                        config.options.plugins = {
                            datalabels: {
                                formatter: function (value, context) {
                                    return formatValue(value, 0, dataColFormat);
                                }
                            }
                        }

                    } else {
                        config.options.plugins = {
                            datalabels: {
                                formatter: function (value, context) {
                                    return formatValue(value, 0, 'Amount');
                                }
                            }
                        }

                    }
                    var div = document.createElement("div")
                    div.innerHTML=hc;

                    console.log(hc)
                    if(tab =='Dashboard') {
                        dashboardCol1DIV.append(div)
                    } else if(tab =='Labor') {
                        var divName='labor'+h.replaceAll(' ','')
                        document.getElementById(divName).innerHTML=hc
                    } else if(tab =='TimeData') {
                        var divName='timeData'
                        document.getElementById(divName).innerHTML=hc
                    }

                    if (createChart) {
                        console.log(h + '\n' + JSON.stringify(config))
                        var dn='donut' + h
                        var chartStatus = Chart.getChart(dn); // <canvas> id
                        if (chartStatus != undefined) {
                            chartStatus.destroy();
                        }
                        var chartCanvas = document.getElementById(dn).getContext('2d');
                        chartCanvas.textBaseline = "middle";
                        var chart = new Chart(chartCanvas, config);
                        //chart.canvas.parentNode.style.height = '128px';
                        //chart.canvas.parentNode.style.width = '128px';
                    }
                    if (h=='Employee Cost') {
                        hc=hc.replace('dashboardEmployee Cost','laborEmployeeCost').replace('donutEmployee Cost','donutLaborEmployee Cost')
                        var dn='donutLabor' + h
                        document.getElementById('laborEmployeeCost').outerHTML=hc
                        var chartStatus = Chart.getChart(dn); // <canvas> id
                        if (chartStatus != undefined) {
                            chartStatus.destroy();
                        }
                        var chartCanvas = document.getElementById(dn).getContext('2d');
                        chartCanvas.textBaseline = "middle";
                        var chart = new Chart(chartCanvas, config);
                    }


                    //break

                })  ;
            })  ;
            var tbn='tbTimeData'
            var tbTimeData=document.getElementById(tbn)
            if (tbTimeData) {
                var data = projectData['Time Data'].rows
                /*                for (var ri = 0; ri < data.length; ri++) {
                                    var row = data[ri]
                                    console.log(ri + ':' + row.length)
                                }*/
                var table
                if ( $.fn.dataTable.isDataTable( '#' + tbn) ) {
                    table = $( '#' + tbn).DataTable();
                    table.clear();
                    table.rows.add(data);
                    table.draw();
                } else {
                    var table = new DataTable('#' + tbn, {
                        fixedHeader: true,
                        lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],
                        columns: [
                            {title: 'Employee'},
                            {title: 'Activity Date',
                                'render': function (data, type, full, meta) {
                                    return data.substring(0,10)
                                },
                            },
                            {title: 'Product/Service'},
                            {
                                title: 'Memo/Description',
                                'render': function (data, type, full, meta) {
                                    return data.replaceAll('\n','<br>')
                                },
                            },
                            {
                                title: 'Duration',
                                'render': function (data, type, full, meta) {
                                    return formatValue(data, 1, 'Number');
                                },
                            },
                            {
                                title: 'Cost Rate',
                                'render': function (data, type, full, meta) {
                                    return formatValue(data, 2, 'Amount');
                                },
                            },
                            {
                                title: 'Cost',
                                'render': function (data, type, full, meta) {
                                    return formatValue(data, 2, 'Amount');
                                },
                            },
                        ],
                        data: data,
                        footerCallback: function (row, data, start, end, display) {
                            let api = this.api();

                            // Remove the formatting to get integer data for summation
                            let intVal = function (i) {
                                return typeof i === 'string'
                                    ? i.replace(/[\$,]/g, '') * 1
                                    : typeof i === 'number'
                                        ? i
                                        : 0;
                            };


                            var dTotal = api.column(4).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                            dTotal=formatValue(dTotal,1,'Number');
                            var cTotal = api.column(6).data().reduce((a, b) => intVal(a) + intVal(b), 0);
                            cTotal=formatValue(cTotal,2,'Amount');

                            // Update footer
                            api.column(4).footer().innerHTML = dTotal;
                            api.column(6).footer().innerHTML = cTotal;
                        }
                    });

                }
            }
            var tbn='tbProjectTeam'
            projectTeamDropdown='<option value="">Select One</option>'
            var tbProjectTeam=document.getElementById(tbn)
            if (tbProjectTeam) {
                var data = Object.keys(projectData['Project Team']), datao = []
                for (var ri = 0; ri < data.length; ri++) {
                    var nm = data[ri]
                    datao.push([nm, projectData['Project Team'][nm]])
                    projectTeamDropdown += `<option value="${nm}"> ${nm}</option>`;
                }
                $('.projectTeamDropdown').html(projectTeamDropdown)
                var table
                if ( $.fn.dataTable.isDataTable( '#' + tbn) ) {
                    table = $( '#' + tbn).DataTable();
                    table.clear();
                    table.rows.add(data);
                    table.draw();
                } else {
                    var table = new DataTable('#' + tbn, {
                        //dom: 'ft',
                        paging: false,
                        info: false,
                        autoWidth: false,
                        layout:{top: ['search'],topEnd:null,bottom: null},
                        //searching: false,
//                        lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],
                        columns: [
                            {title: 'Name'},
                            {
                                title: 'Labor Cost',
                                'render': function (data, type, full, meta) {
                                    return formatValue(data, 2, 'Amount');
                                },
                            },
                        ],
                        data: datao,
                    });
                }
            }

            createBudgetTable()

        }

        function createBudgetTable() {
            var tbn='tbBudget'
            var tbBudget=document.getElementById(tbn)
            var msg=''
            if (tbBudget) {
                var title=projectData.ProjectName+'-Budget Export'
                var startDateX = projectData.StartDate.substring(0,7) + '-01'
                var endDateX = projectData.EndDate.substring(0,7) + '-01'
                var startDate = moment(startDateX)
                var endDate = moment(endDateX)
                var ccdata = allProjectData['Cost Codes'], data = []
                months_YYYY_MM=['Code','Team']
                var baseRow=['','']
                totalsRow=['','']
                var columns=[{title:'Cost Code',footer:'TOTALS', width: '1px' ,'render': function (data, type, full, meta) {return '<span style="color:transparent">'+data+'</span>';}},{title:'Team',footer:''}]
                var pd=projectData['Budget']
                while (startDate<=endDate){
                    var mo=startDate.format('YYYY-MM')
                    var moC=startDate.format('MMM YYYY')
                    months_YYYY_MM.push(mo)
                    months_MMM_YYYY.push(moC)
                    baseRow.push('')
                    totalsRow.push(0)
                    startDate=startDate.add(1, 'month')
                    columns.push({title:moC,footer:moC})
                }
                months_YYYY_MM.push('Total Hours')
                months_YYYY_MM.push('Total Cost')
                columns.push({title:'Total Hours',footer:'total hours',className:'colBorderLeft'})
                columns.push({title:'Total Cost',footer:'total cost'})
                console.log(columns.length+' Columns:'+JSON.stringify(columns))
                var pdl=projectData
                var totHours=0,totCost=0
                for (var cci = 1; cci < ccdata.length; cci++) {
                    //loop thru cost codes
                    var row = ccdata[cci]
                    var codeX = row[0]
                    codeX=new Intl.NumberFormat(undefined, {style: 'decimal',maximumFractionDigits: 0,minimumFractionDigits: 0,minimumIntegerDigits:2}).format(codeX)
                    var codeF = codeX + '-' + row[1]
                    var codeRow = JSON.parse(JSON.stringify(baseRow))
                    codeRow[0]=codeF
                    codeRow.push('')
                    codeRow.push('')
                    var bdData = pd[codeX] //project data for cose code
                    if(bdData){
                        var codeRows = []
                        var x=''
                        Object.keys(bdData).sort().forEach(function (key) {
                            //for each employee
                            var empD = bdData[key]
                            var empRow = JSON.parse(JSON.stringify(baseRow))
                            empRow[0]=codeF
                            empRow[1]=key
                            var emptot=0,empCost=0
                            var empCnt=1
                            Object.keys(empD).sort().forEach(function (mkey) {
                                //for each month
                                var hrs=empD[mkey]
                                var idx=months_YYYY_MM.indexOf(mkey)
                                if (idx<0) {
                                    var m=mkey +'is out side the Project start('+projectData.StartDate+') and end('+projectData.EndDate+') dates. Please update the dates and refresh the page<br>'
                                    msg+=m
                                    console.warn(empCnt+':'+mkey+':'+hrs+' tot:'+emptot+':ERROR:'+m)
                                } else {
                                    if(hrs) {
                                        empRow[idx] = hrs
                                        codeRow[idx] += hrs
                                        totalsRow[idx] += hrs
                                        var totalsRowL = totalsRow
                                        emptot += hrs
                                        //console.log(mkey+':'+hrs)
                                    } else {
                                        var totalsRowL = totalsRow

                                    }
                                    console.log(empCnt + ':' + mkey + ':' + hrs + ' tot:' + emptot)

                                }
                                empCnt++
                            });
                            var empRate=projectData['Project Team'][key]
                            if ((empRate)) {
                                empCost=formatValue(emptot*empRate,2,'Amount')
                                totCost+=(emptot*empRate)
                            } else {
                                empCost=0
                                var m='No Rate for '+key+'<br>'
                                if (msg.indexOf(m)<0)msg+=m
                                console.warn('ERROR No Rate for '+key)

                            }
                            empRow.push(emptot)
                            empRow.push(empCost)
                            totHours+=emptot
                            codeRows.push(empRow)
                            console.log(empRow.length+':'+JSON.stringify(empRow))
                        });
                        //data.push(codeRow)
                        data=data.concat(codeRows)
                        collapsedGroups[codeF] = false
                    } else {
                        data.push(codeRow)
                        console.log(codeRow.length+':'+JSON.stringify(codeRow))
                        collapsedGroups[codeF] = true
                    }
                }
                totalsRow.push(totHours)
                totalsRow.push(totCost)
                console.log(collapsedGroups.length+' collapsedGroups:'+JSON.stringify(collapsedGroups))
                console.log(columns.length+' Columns:'+JSON.stringify(columns))
                console.log(totalsRow.length+' Totals Row:'+JSON.stringify(totalsRow))
                console.log(JSON.stringify(data))
                var table
                if ($.fn.dataTable.isDataTable('#' + tbn)) {
                    table = $('#' + tbn).DataTable();
//                    table.destroy();
                    table.clear();
                    table.rows.add(data);
                    table.draw();
                    return
                }
                var budgetToolbar = document.createElement('div');
                //changesMade=1
                if ((changesMade)) {
                    budgetToolbar.innerHTML = 'Changes Made';
                } else {
                    budgetToolbar.innerHTML = 'No changes Made';
                }

                    //tbBudget
                    var table = new DataTable('#' + tbn, {
                        stripeClasses: [],
                        //paging: false,
                        //lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],
                        info: false,
                        ordering: false,
                        buttons: [
                            {extend: 'excelHtml5',title: title},
                            {extend: 'spacer'},
                            {extend: 'pdfHtml5',title: title}
                        ],
                        layout: {
                            topStart:null,topEnd: null,
                            bottom: null ,
                            top1: ['search', budgetToolbar, 'buttons' ],
                        },
                        //scrollCollapse: true,
                        //scrollY: '50vh',
                        //lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],
                        columns: columns,
                        data: data,
                        rowGroup: {
                            startRender: function (rows, group) {
                                var collapsed = !!collapsedGroups[group];
                                var cl = ''
                                if ((collapsed)) cl = 'class="collapsed"'


                                var cnt= rows.data().pluck(1).length //count employees
                                var xx = '<th colspan="2"><button class=button onclick="addEmployee(\'' + group + '\')" value="+">+</button> ' + group + ' ('+cnt+')</th>'

                                var trE = $('<tr/>')
                                    .append(xx)
                                    .attr('data-name', group)
                                for (var i = 2; i < months_YYYY_MM.length; i++) {
                                    var mo = months_YYYY_MM[i]
                                    var sum = 0
                                    var vals= rows.data().pluck(i) //get all vals in column i
                                    for (var vi = 0; vi < vals.length; vi++) {
                                        var v = vals[vi]
                                        if (v != '') {
                                            var x = v.toString().replace(/[^0-9.-]+/g, "")
                                            sum += parseFloat(x)
                                        }
                                    }
                                    //if (sum ==0) sum=''
                                    if (mo == 'Total Cost') sum = formatValue(sum, 2, 'Amount')
                                    if (mo == 'Total Hours') {
                                        trE.append('<th class="colBorderLeft" style="text-align:right">' + sum + '</th>')
                                        //if (sum==0) collapsed=true

                                    } else {
                                        trE.append('<th style="text-align:right">' + sum + '</th>')
                                    }
                                    //tr+='<th >' + months_YYYY_MM[i]+'</th>'

                                }
                                rows.nodes().each(function (r) {
                                    r.style.display = collapsed ? 'none' : '';
                                });
                                trE.toggleClass('collapsed', collapsed);
                                console.log(xx)
                                console.log(trE[0].outerHTML)
//                                var trE = document.createElement('tr');
//                                trE.innerHTML = tr

                                return trE;
                            },

                            dataSrc: 0
                        },
                        footerCallback: function (row, data, start, end, display) {
                            console.log(columns.length+' Columns:'+JSON.stringify(columns))
                            console.log(totalsRow.length+' Totals Row:'+JSON.stringify(totalsRow))
                            var api = this.api();

                            // Update footer
                            var f=api.column(0).footer().innerHTML = 'TOTALS'
                            api.column(0).footer()
                            for (var i = 2; i < totalsRow.length; i++) {
                                console.log(i+' footer:'+totalsRow[i])
                                console.log(i+' columns:'+JSON.stringify(columns[i]))
                                var c=api.column(i)
                                //var f=api.column(i).footer()
                                var v=totalsRow[i]
                                var x = v.toString().replace(/[^0-9.-]+/g, "")
                                x= parseFloat(x)
                                if(i==totalsRow.length-1){
                                    v=formatValue(v,2,'Amount')
                                } else {
                                    v=formatValue(v,0,'Number')
                                }
                                api.column(i).footer().innerHTML = v
                            }
                        }
                    });
/*                    $('#tbBudget tbody').on('click', 'tr.dtrg-start', function () {
                        var cla=$(this)[0].classList
                        if (!addEmployeeClicked) {
                            var name = $(this).data('name');
                            collapsedGroups[name] = !collapsedGroups[name];
                            var table = $('#tbBudget').DataTable();
                            table.draw(false);
                        }
                        addEmployeeClicked=false
                    });*/
                    $('#tbBudget tbody').on('click', 'tr', function () {
                        var cla=$(this)[0].className
                        if (!addEmployeeClicked) {
                            if (cla.indexOf('dtrg-start')>=0) {
                                var name = $(this).data('name');
                                collapsedGroups[name] = !collapsedGroups[name];
                                var table = $('#tbBudget').DataTable();
                                table.draw(false);
                            } else {
                                var cn = $(this)[0].childNodes
                                var ccF = cn[0].innerText
                                var emp = cn[1].innerText
                                addEmployee(ccF, emp)
                            }
                        }
                        addEmployeeClicked=false
                    });
            }
            if (msg) modalMessage('Error',msg,'bg-warning')
            buildEmployee()
        }

        var addEmployeeClicked=false;
        function buildEmployee(e) {
            var bef=$('#addEmpMonths')[0].innerHTML
            if (bef!='') return

            var ht='',cols=6,colVal=12/cols
            for (var i = 0; i < months_MMM_YYYY.length; i += cols) {
                var x='<div class=row>'
                for (var ci = 0; ci < cols; ci ++) {
                    var mo = months_MMM_YYYY[i + ci]
                    if (mo){
                        var mo2=months_YYYY_MM[i+ci+2]
                        var val = i + 1 + ci
                        //val=''
                        x += '<div class=col-' + colVal + '><label class="control-label">' + mo + '</label><input type="number" class="form-control addEmpMonth" id="addEmployeeGroupMo_' + mo2 + '" value="' + val + '"></div>'
                    }else {
                        x += '<div class=col-' + colVal + '></div>'
                    }
                }
                x+='</div>\n\n'
                ht+=x
            }

            console.log(ht)
            $('#addEmpMonths')[0].innerHTML=''
            var bef=$('#addEmpMonths')[0].innerHTML
            $('#addEmpMonths')[0].innerHTML=ht
        }
        function addEmployee(e,emp) {
            addEmployeeClicked = true
            var cc = e.substring(0, 2)
            $('#addEmployeeGroup').val(cc);

            $('.addEmpMonth').val('')

            if (emp) {
                $('#addEmployeeHeader').html('Edit '+e+' for '+emp);
                $('#projectTeamDropdownAddEmployee').val(emp).prop('disabled', true);
                if ((!projectData.Budget[cc])) projectData.Budget[cc] = {}
                var pd = projectData.Budget[cc][emp]
                if (pd) {
                    for (var i = 2; i < months_YYYY_MM.length; i++) {
                        var mo = months_YYYY_MM[i]
                        var v = pd[mo]
                        if (v) {
                            var id = "addEmployeeGroupMo_" + mo
                            $('#' + id).val(v)
                            console.log(id+':'+v)
                        }
                    }
                }
            } else {
                $('#addEmployeeHeader').html('Add member to '+e);

                //for testing
                $('#projectTeamDropdownAddEmployee').val('Leefa Roe').prop('disabled', false);
                var i=1
                $('.addEmpMonth').each ( function() {
                    $(this).val(i)
                    i++
                })

            }


            $('#addEmployeeModal').modal('show');
        }
        function addEmployeeAfter(form) {
            var cc=$('#addEmployeeGroup').val();
            var emp=$('#projectTeamDropdownAddEmployee').val();
            if ((!projectData.Budget[cc]))projectData.Budget[cc]={}
            if ((!projectData.Budget[cc][emp]))projectData.Budget[cc][emp]={}
            var x=projectData.Budget[cc]
            projectData.Budget[cc][emp][months_YYYY_MM[2]]=0
            console.log(months_YYYY_MM)
            var ma=months_YYYY_MM
            //addEmpMonth" id="addEmployeeGroupMo_
            var sum=0
            $('.addEmpMonth').each ( function() {
                var id=$(this).attr('id')
                var v=$(this).val()
                if ((v)) {
                    v=parseInt(v)
                    sum+=v
                }
                var [pref,mo]=id.split('_')
                if (!projectData.Budget[cc][emp][mo]) projectData.Budget[cc][emp][mo]={}
                projectData.Budget[cc][emp][mo]=v
                var pd=projectData.Budget[cc][emp]
                console.log(cc+'.'+emp+'.'+mo+'='+v)
            });
            console.log(JSON.stringify(projectData.Budget[cc][emp]))
            if(sum==0){
                modalMessage('Error', 'Enter a numeric value in at least one month.')
                return
            }

            $('#addEmployeeModal').modal('hide');
            changesMade=true
            createBudgetTable()
        }

        function addCell(tr, content, colSpan=1) {
            let td = document.createElement('th');

            td.colSpan = colSpan;
            td.textContent = content;

            tr.appendChild(td);
        }
        function supportSetup() {
            var supportUrl = 'https://docs.google.com/forms/d/e/1FAIpQLSeF64RwJRwWzP2sHW5uAWRoFx1QLK6pRNKlIqjfYcX1ckAkpw/viewform?usp=pp_url&entry.201223031=xxxUserNamexxx'

            var formObject = {}
            mergeHash(formObject, userH)


            var userAgent = encodeURIComponent(userH.Role + ';' + userH.Name + ':' + userH.Email + ':' + env + ':' + window.navigator.userAgent)
            supportUrl = supportUrl.replace('xxxUserNamexxx', userAgent)
            console.log(supportUrl)
            $('#supportLink').attr('href', supportUrl);
        }

        Chart.defaults.color = '#000';
        Chart.defaults.set('plugins.datalabels', {
            formatter: function(value, context) {return formatValue(value,0);}
        });
        function formatValue(v,decimals,format) {
            var vo=v
            if (v=='')return v
            if (format== 'Amount') {
                vo=new Intl.NumberFormat(undefined, {
                    style: 'currency',
                    currency: 'USD',
                    maximumFractionDigits: decimals,
                    minimumFractionDigits: decimals,
                }).format(v)
            } else if (format == 'Percent') {
                vo = Math.round(v*100)+'%'
            } else if (format == 'Number') {
                vo=new Intl.NumberFormat(undefined, {
                    style: 'decimal',
                    maximumFractionDigits: decimals,
                    minimumFractionDigits: decimals,
                }).format(v)
            }
            return vo
        }

        function navbarSelected(nm) {
            if (debug == 'Y') console.log('in navbarselected:'+nm)
            if(nm=='Projects'){
                $('#projectHeader').html('All Projects')

            } else {
                var pnm=projectData.ProjectName
                if(pnm){
                    $('#projectHeader').html(pnm)
                }
            }
            $('.mynavbar').each ( function() {
                if($(this).text() === nm)
                {
                    $(this).addClass( 'mynavbarselected')
                }               else{
                    $(this).removeClass( 'mynavbarselected')

                }
            });
            openSection(nm+'DIV')
            $('.datatable').each(function(){
                var id = $(this).attr("id");
                var table=  $('#'+id).DataTable()
                var fhB=table.fixedHeader.enabled()
                var divNm='tb'+nm.replaceAll(' ','')
                if (id ==divNm) {
                    table.fixedHeader.enable();
                } else {
                    table.fixedHeader.disable();
                }
                var fhA=table.fixedHeader.enabled()
            });
        }
        function projectPicked(nm) {
            if (debug == 'Y') console.log('in projectPicked:'+nm)
            $('#projectHeader').html(projectData.ProjectName)
            $('.projectSelected').each(function () {
                var elem = $(this)[0];
                elem.style.display = 'block'
            });
            $('#addEmpMonths')[0].innerHTML=''
            projectSetup()
            navbarSelected('Dashboard')
        }

        function openSection(sectionDiv) {
            $('.majorSection').each(function () {
                var elem = $(this)[0];
                elem.style.display = 'none'
            });

            var nm=sectionDiv.replace(' ','')
            var sd = document.getElementById(nm)
            if (sd) {
                sd.style.display = 'block'
                //sd.scrollIntoView(true)
            } else {
                var nm=sectionDiv.replace('DIV','')
                alert(nm+' section not implemented')
            }
        };
        function functionInit() {
            $.fn.selectpicker.Constructor.BootstrapVersion = '4';
            preventFormSubmit()
            processRole()
            allProjectSetup()
            //return
            projectPicked('999901 - Test Project 1')
            navbarSelected('Budget')
            //addEmployee('01 - Discovery')


            return
            if (debug == 'Y') console.log('in functionInit ')
            googleCallBefore('Loading, please wait...')
            if (debug == 'Y') console.log(JSON.stringify(interactionData))
            supportSetup()

            preventFormSubmit();

            var cd = customerData


            if (debug == 'Y') console.log(JSON.stringify(userH))


            var iaHideColumns = [1, 10]
            var naHideColumns = [1, 9]
            if (userH.Role == 'View') {
                iaHideColumns = [1, 7, 9, 10]
                naHideColumns = [1, 8, 9]
            }

            $('#mainHeader').html(title)
            $('#supportRequestEmail').html(userH.Email)
            $('.envInput').val(env)
            $('.useTestDataInput').val(useTestData)
            $('.userEmailInput').val(userH.Email)
            $('.userNameInput').val(userH.Name)
            var detailsLen = 40

            var mydom = "<'row'<'col-sm-3'l><'col-md' <\"dbtInteractionTitle\">><'col-md-auto' <\"dbtInteractionAddButton\">>>" +
                "<'row'<'col-sm-12'tr>>" +
                "<'row'<'col-md'i><'col-md-auto'p>>"
            if (debug == 'Y') console.log('iaHideColumns:' + iaHideColumns)
            interactiondatatable = new DataTable('table.interaction', {
                responsive: true,
                responsive: {
                    details: {display: $.fn.dataTable.Responsive.display.childRowImmediate}
                },
                order: {idx: 3, dir: 'desc'},
                lengthMenu: [{label: 'All', value: -1}, 10, 25, 50, 100],
                dom: mydom,
                columns: [

                    {
                        title: 'Customer',
                        'render': function (data, type, full, meta) {
                            var cust = customerData  [data]
                            var nm = customerName(cust)
                            var color = 'btn-primary'

                            if (cust.wisdom) {
                                if (cust.wisdom.indexOf('STD') >= 0) color = 'btn-success'
                                if (cust.wisdom.indexOf('REV') >= 0) color = 'btn-warning'
                            }
                            var x = '<button type="button" class="btn btn-sm ' + color + ' pop w-100 h-100" name=customerViewButton title="Customer: ' + nm + '" data-trigger="hover focus" data-toggle="popover" data-message="cust,' + data + ',both" >' + nm + '</button>'
                            return x;
                        },
                    },
                    {title: 'interactionID'},
                    {title: 'Pipeline'},
                    {
                        title: 'When',
                        'render': function (data, type, full, meta) {
                            return '<span style="white-space:nowrap">' + data + "</span>";
                        },
                    },
                    {title: 'Interaction<br>Type'},
                    {
                        title: 'Interaction',
                        'render': function (data, type, full, meta) {
                            var v = data
                            if (meta.settings.sTableId == 'interactiondatatable') {
                                var vs = data
                                if (v.length > detailsLen) {
                                    v = v.replace(/\"/g, "'")
                                    vs = v.substring(0, (detailsLen - 3)) + '...'
                                }
                                var x = '<span class="pop" data-trigger="hover focus" data-toggle="popover" title="Interaction Details" data-message="interaction,' + full[1] + '" >' + vs + '</span>'
                            } else {
                                var x = data.replaceAll('\n', '<br>')
                            }
                            return x;
                        }
                    },
                    {title: 'Interaction By'},
                    {
                        title: 'Customer<br>Initiated',
                        render: function (data, type, row) {
                            var checked = ''
                            if (data == 'Yes') checked = 'checked'
                            return '<input type="checkbox" value="Yes" ' + checked + '>';
                        }

                    },
                    {
                        title: 'Lead<br>Source',
                        'render': function (data, type, full, meta) {
                            var v = data
                            if (meta.settings.sTableId == 'interactiondatatable') {
                                var vs = data
                                if (v.length > detailsLen) {
                                    v = v.replace(/\"/g, "'")
                                    vs = v.substring(0, (detailsLen - 3)) + '...'
                                }
                                var x = '<span class="pop" data-trigger="hover focus" data-toggle="popover" title="Interaction Details" data-message="interaction,' + full[1] + '" >' + vs + '</span>'
                            } else {
                                var x = data.replaceAll('\n', '<br>')
                            }
                            return x;
                        }
                    },
                    {
                        title: '',
                        width: '5%',
                        render: function (data, type, row, meta) {
                            var x = '<small><button type="button" class="btn btn-sm btn-primary " name=addInteractionButton title="Add Interaction" onclick="interactionAdd(\'' + row[0] + '\',\'' + row[2] + '\')">Add</button></small>';
                            if (meta.settings.sTableId == 'custInteractions') {
                                if (userH.Role == 'Admin' || (userH.Role == 'Edit' && userH.Email == row[9])) {
                                    x += '&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-sm btn-success" title="Edit Interaction" >Edit</button>'
                                }
                            }
                            return x
                        }
                    },
                ],
                columnDefs: [

                    {targets: iaHideColumns, visible: false, searchable: false},
                    {targets: 0, responsivePriority: 1},
                    {targets: 1, responsivePriority: 99},
                    {targets: 2, responsivePriority: 3},
                    {targets: 3, responsivePriority: 4},
                    {targets: 4, responsivePriority: 6},
                    {targets: 5, responsivePriority: 2},
                    {targets: 6, responsivePriority: 5},
                    {targets: 7, responsivePriority: 99},
                    {targets: 8, responsivePriority: 7},
                    {targets: 9, responsivePriority: 99},

                ],
                "initComplete": function () {
                    $("#inttitle").html('Interactions');
                },
                data: interactionData,
            });
            interactiondatatable.on('click', 'button', function (e) {
                let row = interactiondatatable.row(e.target.closest('tr')).data();
                if (!row) {
                    var custdt = $('#custInteractions').DataTable()
                    row = custdt.row(e.target.closest('tr')).data();
                }
                if (debug == 'Y') console.log(e.target.outerHTML)
                if (e.target.name == 'customerViewButton' || e.target.innerText == 'View Customer') {
                    customerView(row)
                } else if (e.target.innerText == 'Edit') {
                    interactionEdit(row)
                }
            });
            mydom = mydom.replaceAll('dbtInteraction', 'dbtNA')
            if (debug == 'Y') console.log(mydom)
            nextactiondatatable = new DataTable('table.nextaction', {
                responsive: true,
                responsive: {
                    details: {display: $.fn.dataTable.Responsive.display.childRowImmediate}
                },
                dom: mydom,
                order: {idx: 3, dir: 'asc'},
                lengthMenu: [{label: 'All', value: -1}, 10, 25, 50, 100],
                columns: [
                    {
                        title: 'Customer',
                        'render': function (data, type, full, meta) {
                            var cust = customerData  [data]
                            var nm = customerName(cust)
                            var color = 'btn-primary'

                            if (cust.wisdom) {
                                if (cust.wisdom.indexOf('STD') >= 0) color = 'btn-success'
                                if (cust.wisdom.indexOf('REV') >= 0) color = 'btn-warning'
                            }
                            var x = '<button type="button" class="btn btn-sm ' + color + ' pop w-100 h-100" name=customerViewButton title="Customer: ' + nm + '" data-trigger="hover focus" data-toggle="popover" data-message="cust,' + data + ',both" >' + nm + '</button>'
                            return x;
                        }
                    },
                    {title: 'nextactionID'},
                    {title: 'Pipeline'},
                    {
                        title: 'Date Due',
                        'render': function (data, type, full, meta) {
                            return '<span style="white-space:nowrap">' + data + "</span>";
                        },
                    },
                    {title: 'Lead<br>Priority'},
                    {
                        title: 'Action',
                        'render': function (data, type, full, meta) {
                            var v = data
                            if (meta.settings.sTableId == 'nextactiondatatable') {
                                var vs = data
                                if (v.length > detailsLen) {
                                    v = v.replace(/\"/g, "'")
                                    vs = v.substring(0, (detailsLen - 3)) + '...'
                                }
                                var x = '<span class="pop" data-trigger="hover focus" data-toggle="popover" title="Next Action Details" data-message="nextaction,' + full[1] + '" >' + vs + '</span>'
                            } else {
                                var x = data.replaceAll('\n', '<br>')
                            }
                            return x;
                        }
                    },
                    {title: 'Person Responsible'},
                    {title: 'Completed'},
                    {
                        title: '',

                        render: function (data, type, row, meta) {
                            var x = '<small><button type="button" class="btn btn-sm btn-primary  " name=addNextactionButton title="Add Interaction" onclick="nextactionAdd(\'' + row[0] + '\',\'' + row[2] + '\')">Add</button></small>';
                            if (meta.settings.sTableId == 'custNextActions') {
                                if (userH.Role == 'Admin' || (userH.Role == 'Edit' && userH.Email == row[9])) {
                                    x += '&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-sm btn-success" name="editNextactionButton" title="Edit Next Action" >Edit</button>'
                                    if (row[7] == '') {
                                        x += '&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-sm btn-warning" name="markCompleteNextactionButton" title="Mark Next Action Complete" >Mark Complete</button>'
                                    }
                                }
                            }
                            return x
                        }
                    },

                ],
                columnDefs: [

                    {targets: naHideColumns, visible: false, searchable: false},
                    {
                        target: 3, "createdCell": function (td, data, rowData, row, col) {
                            if (data && data < today && rowData[7] == '') {
                                $(td).addClass('bg-warning');
                            }
                        }
                    },
                    {targets: 0, responsivePriority: 1},
                    {targets: 1, responsivePriority: 99},
                    {targets: 2, responsivePriority: 3},
                    {targets: 3, responsivePriority: 4},
                    {targets: 4, responsivePriority: 6},
                    {targets: 5, responsivePriority: 2},
                    {targets: 6, responsivePriority: 5},
                    {targets: 7, responsivePriority: 7},
                    {targets: 8, responsivePriority: 99},
                    {targets: 9, responsivePriority: 99},
                ],
                createdRow: function (row, data, dataIndex) {
                    if (data[7] != '') {
                        $(row).addClass('completed');
                    }
                },
                data: nextactionData,
            });

            nextactiondatatable.on('click', 'button', function (e) {
                //let row = interactiondatatable.row(e.target.closest('tr')).data();
                let row = nextactiondatatable.row(e.target.closest('tr')).data();
                if (debug == 'Y') console.log('nextaction table button clicked:' + e.target.name + ' ' + e.target.innerText)
                if (!row) {
                    var custNAdt = $('#custNextActions').DataTable()
                    row = custNAdt.row(e.target.closest('tr')).data();
                }
                if (e.target.name == 'customerViewButton') {
                    customerView(row)
                } else if (e.target.innerText == 'Edit') {
                    nextactionEdit(row)
                } else if (e.target.innerText == 'Mark Complete') {
                    nextActionMarkComplete(row)
                } else {

                }
            });

            var wbc = lists['Wisdom Program Codes']

            var custCourseHistory = new DataTable('#custCourseHistory', {
                dom: "<'row'<'col-sm-3'l><'col-md' <\"dbtHistoryTitle\">><'col-md-auto' f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-md'i><'col-md-auto'p>>",


                lengthMenu: [{label: 'All', value: -1}, 10, 25, 50, 100],
                order: {idx: 8, dir: 'desc'},
                columns: [
                    {title: 'Customer ID'},
                    {title: 'CourseID'},
                    {title: 'AppCode'},
                    {title: 'Program Code'},
                    {title: 'Program Name', width: '50%'},
                    {title: 'Location'},
                    {title: 'Start Date'},
                    {title: 'Status'},
                    {title: 'Start Date'},
                ],
                columnDefs: [
                    {targets: [0, 2, 6], visible: false, searchable: false},
                    {
                        targets: [8],
                        render: function (data, type, row) {
                            if (data > today) {

                                return "<div class='bg-success text-white'>" + data + "<div>";
                            }
                            return data;
                        }
                    }],
                createdRow: function (row, data, dataIndex) {
                    if (wbc.indexOf(data[3]) >= 0) {
                        $(row).addClass('myblue');
                    }
                },
                data: [],
            });
            var rx = [15657, "Bartell", "Elbert", "Al", "Atlanta", "GA", "US", "", "", "404-461-6653", "eabtell@gmail.com", "", "", "", "663839", "PAM"]
            //      h.row = [custId, h['Last'], h['First'], h['Likes'], h['City'], h['State'], h['Country'], h['HomePhone'], h['WorkPhone'], h['MobilePhone'], h['Email'], h['BestTime'], '', '', h.LISA, 'PAM']


            var ret = {
                "msg": "Returned 2", "rc": 1, "hout": {
                    "14912": {
                        "courses": "BOW,CAM,CGT,DCRR,PEX,PLD,SEO,TYS,WAC,WIS,YE,YEAT,YELE",
                        "lastPAMcourseDt": "2023-05-19",
                        "Email": "leefaroe@yahoo.com"
                        ,
                        "WorkPhone": "",
                        "LISA": "6269365",
                        "lastWisdomDate": "",
                        "lastPAMcourse": "Conference for Global Transformation",
                        "source": "PAM",
                        "City": "San Diego"
                        ,
                        "coursHistory": [["14912", "227", "REGFF", "WIS", "Wisdom Unlimited", "Atlanta", "2017-03-17T00:00:00", "REV", "2017-03-17"], ["14912", "232", "REGFF", "WIS", "Wisdom Unlimited", "San Diego", "2017-03-24T00:00:00", "REV", "2017-03-24"], ["14912", "243", "REGFF", "YE", "Year-end Vacation", "Riviera Maya, Mexico", "2017-12-02T00:00:00", "STD", "2017-12-02"], ["14912", "298", "REGFF", "WIS", "Wisdom Unlimited", "San Diego", "2018-07-27T00:00:00", "REV", "2018-07-27"], ["14912", "308", "REGFF", "YE", "Year-end Vacation", "Riviera Maya, Mexico", "2018-12-01T00:00:00", "STD", "2018-12-01"], ["14912", "342", "REGFF", "YEAT", "Year-end Vacation Assisting Team", "Wisdom Central Office", "2022-11-01T00:00:00", "WD", "2022-11-01"], ["14912", "353", "REGFF", "TYS", "Transforming Yesterday's Strategies", "Puerto Vallarta", "2019-08-02T00:00:00", "STD", "2019-08-02"], ["14912", "360", "REGFF", "YE", "Year-end Vacation", "Los Cabos, Mexico", "2019-12-02T00:00:00", "STD", "2019-12-02"], ["14912", "404", "REGFF", "DCRR", "Developmental Course on Relating and Relationships", "Web (Online)", "2020-04-24T00:00:00", "WD", "2020-04-24"], ["14912", "438", "REGFF", "BOW", "A Bit of Wisdom", "San Diego", "2020-04-25T00:00:00", "WD", "2020-04-25"], ["14912", "440", "REGFF", "BOW", "A Bit of Wisdom", "Denver", "2020-05-02T00:00:00", "WD", "2020-05-02"], ["14912", "483", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2021-05-21T00:00:00", "STD", "2021-05-21"], ["14912", "505", "REGFF", "SEO", "Structural Explorations Online", "Web (Online)", "2021-11-01T00:00:00", "STD", "2021-11-01"], ["14912", "510", "REGFF", "CAM", "Center Assisting Meeting", "North America / Australia", "2021-03-12T00:00:00", "P", "2021-03-12"], ["14912", "515", "REGFF", "PLD", "Program Leader Day", "Web (Online)", "2021-05-26T00:00:00", "P", "2021-05-26"], ["14912", "587", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2023-05-19T00:00:00", "STD", "2023-05-19"], ["14912", "332", "PEXPM", "PEX", "Partnership Explorations", "Los Angeles", "2019-06-22T00:00:00", "P", "2019-06-22"], ["14912", "135", "REGFF", "WIS", "Wisdom Unlimited", "Atlanta", "2015-03-13T00:00:00", "STD", "2015-03-13"], ["14912", "161", "REGFF", "YE", "Year-end Vacation", "Guanacaste, Costa Rica", "2015-12-05T00:00:00", "STD", "2015-12-05"], ["14912", "198", "REGFF", "YE", "Year-end Vacation", "Puerto Los Cabos, Mexico", "2016-12-03T00:00:00", "STD", "2016-12-03"], ["14912", "203", "REGFF", "WAC", "WCA Assisting Conference", "San Francisco", "2016-05-23T00:00:00", "R", "2016-05-23"], ["14912", "332", "REGFF", "PEX", "Partnership Explorations", "Los Angeles", "2019-06-22T00:00:00", "STD", "2019-06-22"], ["14912", "410", "REGFF", "YE", "Year-end Vacation", "Panama City, Panama", "2020-11-30T00:00:00", "WD", "2020-11-30"], ["14912", "485", "REGFF", "YELE", "Year-end Vacation Launch Event", "Web (Online)", "2020-10-24T00:00:00", "P", "2020-10-24"], ["14912", "519", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2022-05-20T00:00:00", "WD", "2022-05-20"]],
                        "MobilePhone": "404-825-9436",
                        "wisdom": "N",
                        "Last": "Roe",
                        "HomePhone": "",
                        "ChangeType": "",
                        "State": "CA",
                        "customerID": 14912,
                        "Country": "US",
                        "First": "Leefa",
                        "row": [14912, "Roe", "Leefa", "Leefa", "San Diego", "CA", "US", "", "", "404-825-9436", "leefaroe@yahoo.com", "", "", "", "6269365", "PAM"],
                        "BestTime": "",
                        "Likes": "Leefa"
                    }, "24857": {
                        "courses": "",
                        "lastPAMcourseDt": "",
                        "Email": "lroe@landmarkworldwide.com",
                        "WorkPhone": "",
                        "LISA": "",
                        "lastWisdomDate": "",
                        "lastPAMcourse": "",
                        "City": "",
                        "source": "PAM",
                        "coursHistory": [],
                        "MobilePhone": "",
                        "wisdom": " ",
                        "Last": "Roe",
                        "HomePhone": "",
                        "ChangeType": "",
                        "State": "",
                        "customerID": 24857,
                        "Country": "",
                        "First": "Leefa",
                        "BestTime": "",
                        "row": [24857, "Roe", "Leefa", "", "", "", "", "", "", "", "lroe@landmarkworldwide.com", "", "", "", "", "PAM"],
                        "Likes": ""
                    }
                }
            }
            var cols = 'Home Phone,Work Phone,Mobile Phone,Email,Best Time To Call,cuLastParticipationDate,cuLastParticipationComment,LISA,wisdom,lastPAMcourse,cuUpdateDate,UpdateDate'.split(',')
            var colNames = 'Home Phone,Work Phone,Mobile Phone,Email,Best Time To Call,Last Participation Date,Last Participation Comment,LISA ID,Wisdom,Newest PAM Course,Customer Updated,Other Info Updated'.split(',')
            var cd = ret.hout['14912']
            var c = cd

            if (debug == 'Y') console.log(c)

            var x = ''
            var keys = Object.keys(cd)

            for (var i = 0; i < keys.length; i++) {
                var h = keys[i]
                var l = "{ data: '" + h + "', title: '" + h + "' },\n"
                x += l

            }
            console.log(x)
            for (var i = 0; i < cols.length; i++) {

                var c = cols[i]
                var h = colNames[i]
                var l = "{ data: '" + h + "', title: '" + h + "' },\n"
                x += l

            }
//                      console.log(x)
            //return
            var customerTable = new DataTable('#customerTable', {
                dom: "<'row'<'col-sm-4'l><'col-md' <\"dbtCustomerTitle\">><'col-md-auto' <\"dbtCustomerButton\">><'col-md-2 text-right' f>>" +
                    "<'row'<'col-sm-12'tr>>" +
                    "<'row'<'col-md-4'i><'col-md' <\"dbtCustomerTitle\">><'col-md-auto' <\"dbtCustomerButton\">><'col-md-2 text-right'p>>",
                responsive: true,
                lengthMenu: [{label: 'All', value: -1}, 10, 25, 50, 100],
                order: {idx: 1, dir: 'asc'},
                columns: [
                    {data: 'customerID', title: 'ID'},
                    {data: 'source', title: 'Source'},
                    {data: 'Last'},
                    {data: 'First'},
                    {data: 'Likes'},
                    {data: 'City'},
                    {data: 'State'},
                    {data: 'Country'},
                    {data: 'Mobile Phone'},
                    {data: 'Home Phone',},
                    {data: 'Work Phone'},
                    {data: 'Best Time To Call'},
                    {data: 'Email'},
                    {
                        title: 'LISA ID',
                        'render': function (data, type, full, meta) {
                            if (full.LISA) return full.LISA

                            return '';
                        }
                    },
                    {
                        title: '',
                        'render': function (data, type, full, meta) {
                            var nm = full[1] + ' ' + full[2]
                            var x = '<button type="button" class="btn btn-sm btn-primary w-100 h-100" name=customerViewButton title="Customer View: ' + nm + '" >View</button>'
                            return x;
                        }
                    },
                ],
                data: [],
            });
            customerTable.on('click', 'button', function (e) {
                let row = customerTable.row(e.target.closest('tr')).data();
                if (debug == 'Y') console.log('customerTable table button clicked:' + e.target.name)
                if (e.target.name == 'customerViewButton') {
                    closeSection('customersDIV')

                    customerView(row, 'customersDIV')
                }
            });


            $(".dbtCustomerButton").html('<input class="btn btn-warning btn-sm " type="button" value="Close" onclick="closeSection(\'customersDIV\')"></div>');
            $(".dbtInteractionTitle").html('<h2 class="h2 mb-1 px-3 text-center  bg-primary">Interactions</h2>');
            $(".dbtNATitle").html('<h2 class="h2 mb-1 px-3 text-center  bg-warning">Next Actions</h2>');
            $(".dbtHistoryTitle").html('<h2 class="h2 mb-1 px-3 text-center  bg-success">PAM Course History</h2>');
            $(".dbtInteractionAddButton").html('<button type="button" class="btn btn-warning btn-sm pb-1  " style="margin-bottom:3px" data-trigger="hover focus" title="Add Interaction" value="" onclick="interactionAdd()">Add</button>')
            $(".dbtNAAddButton").html(
                '<button type="button" class="btn btn-secondary btn-sm pb-1" style="margin-bottom:3px" data-trigger="hover focus" title="Hide/Show Completed" value="" onclick="nextactionCompleted(this)">Hide Completed</button>&nbsp;&nbsp;'
                + '<button type="button" class="btn btn-primary btn-sm pb-1  " style="margin-bottom:3px" data-trigger="hover focus" title="Add Next Action" value="" onclick="nextactionAdd()">Add</button>'
            );


            $('.myselect').selectpicker();
            $('.myselect').selectpicker({size: '10'});
            interactionById = {}
            for (var i = 0; i < interactionDataOriginal.length; i++) {
                var row = interactionDataOriginal[i]
                var id = row[1]
                interactionById[id] = row
            }
            nextactionById = {}
            for (var i = 0; i < nextactionDataOriginal.length; i++) {
                var row = nextactionDataOriginal[i]
                var id = row[1]
                nextactionById[id] = row
            }
            interactionTypeSetup()
            customerSetup()
            var pipelines = lists.Pipelines.sort()
            if (debug == 'Y') console.log(JSON.stringify(pipelines))
            var pipelineFilter = ''
            var output = '<option value="">Select One</option>'
            for (var i = 0; i < pipelines.length; i++) {
                var [short, full] = pipelines[i].split('|')
                var display = short.replace('WIS-', 'W-')
                output += `<option value="${short}"> ${full} (${short}) </option>`;

                var b = `<button type="button" class="btn btn-info btn-sm pb-1 Pipeline" style="margin-bottom:3px" data-trigger="hover focus" title="${full}" id="pipeline${short}" value="${short}" onclick="filterClicked(this,\'Pipeline\');">${display}</button>`
                pipelineFilter += b + '\n'
            }
            $('select.pipelineDropdown').html(output);
            $('#pipelineFilterDIV').html(pipelineFilter)

            var nextActionResponsibleList = lists['Next Action Responsible List'].sort()
            if (debug == 'Y') console.log(JSON.stringify(nextActionResponsibleList))
            var output = ''
            for (var i = 0; i < nextActionResponsibleList.length; i++) {
                var short = nextActionResponsibleList[i]
                output += `<option value="${short}">${short}</option>`;
            }
            $('#nextActionResponsibleList').html(output);
            console.log('nextActionResponsibleList:' + output)
            buildDistList()
            $('.myselect').selectpicker('refresh')


            $("#userDIV").click(function (e) {
                var v = $("#userDIV").html()
                if (debug == 'Y') console.log('userDIV clicked:' + v)
                if (env != 'dev') return
                var x = v.split('(')[1]
                var x2 = x.substring(0, 3)
                var role = ''
                if (x.substring(0, 3) == 'Adm') role = 'Edit'
                else if (x.substring(0, 3) == 'Edi') role = 'View'
                else if (x.substring(0, 3) == 'Vie') role = 'Basic'
                else if (x.substring(0, 3) == 'Bas') role = 'Admin'
                else role = 'Basic'
                if (debug == 'Y') console.log('old Role:' + userH.Role + ' new Role:' + role)

                userH.Role = role
                processRole()

            });

            googleCallAfter()


            if (releaseMsg) {
                var i = releaseMsg.indexOf('</h1>')
                var hdr = releaseMsg.substring(0, i).replace('</span>', '').replace(/.*\>/, '')
                var msg = releaseMsg.substring(i + 5)

                $('#releaseHeader').html(hdr);
                $('#releaseMsg').html(msg);
                $('#releaseModal').modal('show');
                releaseMsg = ''
            }

            document.getElementById('topDIV').scrollIntoView(true);
            elapsedTime(startDate, 'After Init')

            if (env != 'dev') return
            if (0) {
                distributionListShow()
                $("#distributionFormSelect").val(1)
                distributionListSelectChanged()
            }
            if (0) {
                var res = {
                    "add": 1,
                    "msg": "Next Action Record Updated",
                    "rc": 1,
                    "row": ["C000000001", "99", "CGT", "2025-01-02", "1", "99 Promise to Register", "Julia Simms", "", "2024-09-25 08:02:46 AM ", "wcasupport@wisdomcoursearea.com"]
                }
                afternextactionFormSubmit(res)
            }
            if (0) {
                var res = {
                    "msg": "Interaction Record Added. 1 Next actions added.", "add": 1, "rc": 1,
                    "row": ["25919", "99", "YEV", "2024-09-25", "Phone Conversation", "99 talked to Rick about YEV - he wants to register for 2026", "WCA Support", "No", "", "2024-09-25 07:26:13 AM ", "wcasupport@wisdomcoursearea.com"],
                    "naRows": [["25919", "9", "YEV", "2025-03-25", "3", "99 register for 2026", "Cynthia Barnett (YEV)", "", "2024-09-25 07:26:13 AM ", "wcasupport@wisdomcoursearea.com", "14"]]
                }

                afterInteractionFormSubmit(res)
            }
            if (0) {
                customerList()
                var ret = {
                    "msg": "Returned 3 customers", "rc": 1, "hout": {
                        "14912": {
                            "courseHistory": [["14912", "587", "REGFF", "CGT", "", "WEB", "5/19/2023", "STD", "2023-05-19"], ["14912", "342", "REGFF", "YEAT", "", "WCO", "11/1/2022", "WD", "2022-11-01"], ["14912", "519", "REGFF", "CGT", "", "WEB", "5/20/2022", "WD", "2022-05-20"], ["14912", "505", "REGFF", "SEO", "", "WEB", "11/1/2021", "STD", "2021-11-01"], ["14912", "515", "REGFF", "PLD", "Program Leader Day", "WEB", "5/26/2021", "P", "2021-05-26"], ["14912", "483", "REGFF", "CGT", "", "WEB", "5/21/2021", "STD", "2021-05-21"], ["14912", "510", "REGFF", "CAM", "", "NAAU", "3/12/2021", "P", "2021-03-12"], ["14912", "410", "REGFF", "YE", "", "PCP", "11/30/2020", "WD", "2020-11-30"], ["14912", "485", "REGFF", "YELE", "", "WEB", "10/24/2020", "P", "2020-10-24"], ["14912", "440", "REGFF", "BOW", "", "DEN", "5/2/2020", "WD", "2020-05-02"], ["14912", "438", "REGFF", "BOW", "", "SD", "4/25/2020", "WD", "2020-04-25"], ["14912", "404", "REGFF", "DCRR", "", "WEB", "4/24/2020", "WD", "2020-04-24"], ["14912", "360", "REGFF", "YE", "", "LCABOS", "12/2/2019", "STD", "2019-12-02"], ["14912", "353", "REGFF", "TYS", "", "PVT", "8/2/2019", "STD", "2019-08-02"], ["14912", "332", "REGFF", "PEX", "", "LA", "6/22/2019", "STD", "2019-06-22"], ["14912", "332", "PEXPM", "PEX", "", "LA", "6/22/2019", "P", "2019-06-22"], ["14912", "308", "REGFF", "YE", "", "RVMM", "12/1/2018", "STD", "2018-12-01"], ["14912", "298", "REGFF", "WIS", "", "SD", "7/27/2018", "REV", "2018-07-27"], ["14912", "243", "REGFF", "YE", "", "RVMM", "12/2/2017", "STD", "2017-12-02"], ["14912", "232", "REGFF", "WIS", "", "SD", "3/24/2017", "REV", "2017-03-24"], ["14912", "227", "REGFF", "WIS", "", "ATL", "3/17/2017", "REV", "2017-03-17"], ["14912", "198", "REGFF", "YE", "", "LCAB", "12/3/2016", "STD", "2016-12-03"], ["14912", "203", "REGFF", "WAC", "", "SF", "5/23/2016", "R", "2016-05-23"], ["14912", "161", "REGFF", "YE", "", "GCR", "12/5/2015", "STD", "2015-12-05"], ["14912", "135", "REGFF", "WIS", "", "ATL", "3/13/2015", "STD", "2015-03-13"]],
                            "courses": "BOW,CAM,CGT,DCRR,PEX,PLD,SEO,TYS,WAC,WIS,YE,YEAT,YELE",
                            "lastPAMcourseDt": "2023-05-19",
                            "Email": "leefaroe@yahoo.com",
                            "LISA": "6269365",
                            "Work Phone": "",
                            "lastPAMcourse": "CGT",
                            "UpdateID": "",
                            "City": "San Diego",
                            "source": "PAM",
                            "Best Time To Call": "",
                            "wisdom": "Y",
                            "UpdateDate": "",
                            "Home Phone": "",
                            "Last": "Roe",
                            "State": "CA",
                            "customerID": "14912",
                            "Country": "US",
                            "row": ["14912", "Roe", "Leefa", "Leefa", "San Diego", "CA", "US", "", "", "404-825-9436", "leefaroe@yahoo.com", "", "", "", "6269365"],
                            "First": "Leefa",
                            "Likes": "Leefa",
                            "Mobile Phone": "404-825-9436"
                        },
                        "24857": {
                            "courseHistory": [],
                            "courses": "",
                            "lastPAMcourseDt": "",
                            "Email": "lroe@landmarkworldwide.com",
                            "LISA": "",
                            "lastPAMcourse": "",
                            "Work Phone": "",
                            "City": "",
                            "source": "PAM",
                            "UpdateID": "",
                            "Best Time To Call": "",
                            "wisdom": "",
                            "UpdateDate": "",
                            "Home Phone": "",
                            "Last": "Roe",
                            "State": "",
                            "customerID": "24857",
                            "Country": "",
                            "row": ["24857", "Roe", "Leefa", "", "", "", "", "", "", "", "lroe@landmarkworldwide.com", "", "", "", ""],
                            "First": "Leefa",
                            "Likes": "",
                            "Mobile Phone": ""
                        },
                        "C000000008": {
                            "courseHistory": [],
                            "courses": "",
                            "lastPAMcourseDt": "",
                            "Email": "leefaroe@gmail.com",
                            "Work Phone": "858-499-5562",
                            "lastPAMcourse": "",
                            "UpdateID": "WCA Support",
                            "source": "CRM",
                            "City": "San Diego",
                            "Best Time To Call": "",
                            "wisdom": "",
                            "Home Phone": "858-485-0946",
                            "UpdateDate": "2024-09-09 05:57:07 PM",
                            "Last": "CRM",
                            "State": "CA",
                            "customerID": "C000000008",
                            "Country": "USA",
                            "row": ["C000000008", "CRM", "Leefa", "", "San Diego", "CA", "USA", "858-485-0946", "858-499-5562", "858 472-3881", "leefaroe@gmail.com", "", "2024-09-09 05:57:07 PM", "WCA Support", ""],
                            "First": "Leefa",
                            "Likes": "",
                            "Mobile Phone": "858 472-3881"
                        }
                    }
                }

                afterCustomerSearch(ret)
            }
            //openSection('supportRequestDIV')

        };

        function addCustomerTest() {
            //customer add with values
            customerView(null, 'customersDIV')
            $('#firstName').val('test')
            $('#lastName').val('add')
            $('#nameLikes').val('')
            $('#email').val('testadd@gmail.com')
            $('#lastParticipation').val('2025-10-01')
            $('#lastParticipationComment').val('sd community gathering')
            $('#MobilePhone').val('4041231234')
            $('#bestTime').val('4-6pm')
            $('#city').val('Atlanta')
            $('#state').val('GA')
            //$('#country').val('USA')
        };

        function interactionTypeSetup() {
            var a = lists['Interaction Types'].sort()
            var radioHTML = "";
            var id = 'id="intType1" '
            $.each(a, function (index, value) {
                radioHTML += '<div class="form-check form-check-inline"><input class="form-check-input" type="radio" name="intType" value="' + value + '" ' + id + 'required><label class="form-check-label">' + value + '</label></div>\n'
                id = ''
            });
            $("#intTypeDIV").html(radioHTML);
            if (debug == 'Y') console.log(radioHTML)
        };

        function processRole() {
            var userName = userH.Name + ' ' + userH.Email + '<br>Role:' + userH.Role
            var userName = userH.Name + ' (' + userH.Role + ')' + '<br>' + userH.Email
            $('#userDIV').html('<small>' + userName + '</small>')
            var vis = true
            if (userH.Role == 'Edit') {
                $('.role-editor').show()
                $('.role-basic').show()
                $('.role-admin').hide()
            } else if (userH.Role == 'Admin') {
                $('.role-editor').show()
                $('.role-basic').show()
                $('.role-admin').show()
            } else if (userH.Role == 'Basic') {
                $('.role-editor').hide()
                $('.role-basic').show()
                $('.role-admin').hide()
            } else {
                $('.role-editor').hide()
                $('.role-basic').hide()
                $('.role-admin').hide()
                vis = false
            }
            if (debug == 'Y') console.log('User role is ' + userH.Role)
            if (userH.Email == 'wcasupport@wisdomcoursearea.com') {
                $('.role-leefa').show()
            } else {
                $('.role-leefa').hide()
            }
            var itb = $('table.interaction')
            for (var i = 0; i < itb.length; i++) {
                var e = itb[i]
                var id = itb[i].id
                var dtb = $('#' + id).DataTable()
                dtb.column(9).visible(vis);
            }
            var itb = $('table.nextaction')
            for (var i = 0; i < itb.length; i++) {
                var e = itb[i]
                var id = itb[i].id
                var dtb = $('#' + id).DataTable()
                dtb.column(8).visible(vis);
            }
        };

        function customerName(ch) {
            var nm = ch.First + ' ' + ch.Last
            if (ch.Likes) nm += ' (' + ch.Likes + ')'
            return nm
        };

        function datePickerSetup() {
            $('.datepicker').datepicker({
                orientation: 'bottom auto',
                todayHighlight: true,
                format: "yyyy-mm-dd",
                todayBtn: 'linked',
                autoclose: true,
            });
            var a = $('#custNextAction_date_1,#custNextAction_date_2,#custNextAction_date_3,#date')
            $('#custNextAction_date_1,#custNextAction_date_2,#custNextAction_date_3,#date').each(function () {
                $(this).datepicker('setStartDate', '0d')
                if (debug == 'Y') console.log(this)
            });
            $("#intWhen,#completedate").each(function () {
                $(this).datepicker('setEndDate', '0d')
            });

        };

        function closeSection(sectionDiv) {
            var lviewCustomerReturn = viewCustomerReturn
            if (sectionDiv == viewCustomerReturn) viewCustomerReturn = ''
            document.getElementById(sectionDiv).style.display = 'none'
            if (viewCustomerReturn) {
                openSection(viewCustomerReturn)
            } else {
                $('#overviewDIV').show()
            }
            if (sectionDiv == 'customerFormDIV') {
                $("#custnavbar").hide()
            }
            document.getElementById('topDIV').scrollIntoView(true);
        };


        function buildDistList() {
            var distributionFormSelect = document.getElementById('distributionFormSelect');
            $("#distributionFormSelect").empty();
            for (var i = 0; i < distLists.length; i++) {
                var row = distLists[i]
                var opt = document.createElement('option');
                if (i == 0) {
                    var id = ''
                    var nm = 'Select One'
                    opt.id = 'distListSelect_All'
                } else {
                    var id = row[0]
                    var nm = row[1]
                    opt.id = 'distListSelect' + id
                }
                opt.value = id;
                opt.innerHTML = nm
                distributionFormSelect.appendChild(opt);
            }
            $("#distributionFormSelect").val('')

            var listsFormSelect = document.getElementById('listsFormSelect');
            $("#listsFormSelect").empty();
            var opt = document.createElement('option');
            var id = ''
            var nm = 'Select One'
            opt.id = 'listsSelect_All'
            opt.value = id;
            opt.innerHTML = nm
            listsFormSelect.appendChild(opt);
            var keys = Object.keys(lists)
            var editableLists = 'Interaction Types,Next Action Responsible List'.split(',')
            for (var i = 0; i < keys.length; i++) {
                var v = keys[i]
                if (editableLists.indexOf(v) >= 0) {
                    var id = v.replaceAll(' ', '')
                    var opt = document.createElement('option');
                    opt.id = 'listsSelect' + id
                    opt.value = v;
                    opt.innerHTML = v
                    listsFormSelect.appendChild(opt);
                }
            }
            $("#listsFormSelect").val('')
            console.log(listsFormSelect.outerHTML)

            $('.myselect').selectpicker('refresh')

        };

        function listsShow() {

            $("#listsListID").val('')
            $('#listsFormSelect').val('')
            $('#listsMessage').html('').removeClass('bg-success').removeClass('bg-warning');

            openSection('listsFormDIV')

            $('#listsForm').hide()
        };

        function listsSelectChanged(e) {
            var v = $("#listsFormSelect option:selected").val()
            var nm = $("#listsFormSelect option:selected").text()
            listsSelect(v.toString(), nm)
        }

        function listsSelect(id, nm) {
            var form = document.getElementById('listsForm')
            form.style.display = 'block'
            $('#listsOutputDIV').hide()
            form.classList.remove('was-validated');

            requiredMark(form.id)


            document.getElementById('listsFormDIV').style.display = 'block'
            $('#listsForm').show()
            $('#listsListID').val(nm)
            var lst = lists[nm]
            if (debug == 'Y') console.log('listsListSelect id:' + id + ' ' + nm)
            var dh = ''
            document.getElementById('listsFormDIV').scrollIntoView(true)


            var ro = []
            for (var i = 0; i < lst.length; i++) {
                ro.push([lst[i]])
            }

            var table = $('#listItemsDatatable').DataTable();
            if (table) table.destroy();

            var table = new DataTable('#listItemsDatatable', {
                stripeClasses: [],
                lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],
                columns: [
                    {
                        title: 'Item ',
                        'render': function (data, type, full, meta) {
                            var x = '<input class="listsItem" type="text" name="listItem" value="' + data + '">'
                            return x;
                        },
                    },
                    {
                        title: '<small><button type="button" class="btn btn-sm btn-success " name=addListItem title="Add List Item" onclick="listsAddNewRow()">Add</button></small>',
                        'render': function (data, type, full, meta) {
                            var x = '<small><button type="button" class="btn btn-sm btn-danger" name="deleteListItem" title="Delete List Item" onclick="listsDeleteItem(' + meta.row + ',\'' + full + '\')">Delete</button></small>';
                            var x = '<small><button type="button" class="btn btn-sm btn-danger" name="deleteListItem" title="Delete List-' + full[0] + '" >Delete</button></small>';
                            return x;
                        },
                    },

                ],
                order: [1, 'asc'],
                data: ro
            });

            $('#listItemsDatatable').on('click', 'button', function (e) {
                if (e.target.name == 'deleteListItem' || e.target.innerText == 'Delete') {
                    console.log('deleteListItem:' + e.target.title)
                    table
                        .row($(this).parents('tr'))
                        .remove()
                        .draw();
                }
            });


        }

        function listsAddNewRow() {
            var table = $('#listItemsDatatable').DataTable();
            table.row
                .add([''])
                .draw(false);
        }

        function listsFormSubmit(formObjectIn) {
            var nm = $("#listsFormSelect option:selected").text()
            var table = $('#listItemsDatatable').DataTable();
            var data = table.rows().data();

            console.log('The table has ' + data.length + ' records');

            var la = $('.listsItem')
            var h = {list: nm, vals: [], userH: userH}
            $('.listsItem').each(function () {
                var lv = $(this).val()
                if (debug == 'Y') console.log(lv)
                h.vals.push(lv)
            });

            if (debug == 'Y') console.log(h)

            googleCallBefore()
            console.log('calling     google.script.run.withSuccessHandler(afterDummySubmit).listsUpdate(h);')
            if (debug == 'Y') console.log(h)
            try {
                google.script.run.withSuccessHandler(afterListsFormSubmit).listsUpdate(h);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {"msg": "no google", "rc": 0}

                    afterDummySubmit(ret)
                }
            }

        }

        function afterListsFormSubmit(res) {
            if (debug == 'Y') console.log('afterListsFormSubmit:' + JSON.stringify(res))


            googleCallAfter()
            displayOutput(res)
            if (res.rc) {
                lists[res.list] = res.vals
                interactionTypeSetup()
                closeSection('listsFormDIV')
            }
        }

        function distributionListShow() {

            $('#distMembersDIV').hide()
            $('#distListMembersDIV').html('')
            $("#distListID").val('')
            $("#distListName").val('')
            $('#distributionFormSelect').val('').selectpicker('refresh')
            $('#distributionMessage').html('').removeClass('bg-success').removeClass('bg-warning');

            openSection('distributionFormDIV')

            $('#distributionForm').hide()
            $('#distributionFormSelect').focus().val('')


        };

        function distributionListSelectChanged(e) {
            var v = $("#distributionFormSelect option:selected").val()
            var nm = $("#distributionFormSelect option:selected").text()
            distributionListSelect(v.toString(), nm)
        }

        function distributionListSelect(id, nm) {
            var form = document.getElementById('distributionForm')
            form.style.display = 'block'
            $('#distributionOutputDIV').hide()
            form.classList.remove('was-validated');

            requiredMark(form.id)

            document.getElementById('distributionFormDIV').style.display = 'block'
            $('#distributionForm').show()
            if (debug == 'Y') console.log('distributionListSelect id:' + id + ' ' + nm)
            var dh = ''
            var currCustInteractions = []
            if ($.fn.dataTable.isDataTable('#distMembersDatatable')) {
                $('#distMembersDatatable').DataTable().destroy();
                $('#distMembersDatatable').empty();
            }
            if (id == 'new') {
                $('#distributionFormSelect').val('').selectpicker('refresh')
                $("#distListName").focus()
                $('#distListMembersDIV').html('')
                $('#distMembersDIV').hide()
            } else {
                $('#distMembersDIV').show()
                dh = '<table id="distMembersDatatable" class="display table table-striped table-bordered w-100"></table>'
                $('#distListMembersDIV').html(dh)
                var tbData = []
                var keys = Object.keys(customerData)
                for (var i = 0; i < keys.length; i++) {
                    var ch = customerData  [keys[i]]
                    if (ch.cuDistLists) {
                        var cdh = ch.cuDistLists.split(',')
                        if (cdh.indexOf(id) >= 0) {
                            var cid = ch.customerID
                            var fst = ch.First
                            if (ch.Likes) fst += ' (' + ch.Likes + ')'
                            var cnm = customerName(ch)
                            var ro = ['Y', fst, ch.Last, ch.Email, cid]
                            tbData.push(ro)
                        }
                    }
                }
                var distMembersDatatable = new DataTable('#distMembersDatatable', {
                    responsive: true,
                    lengthMenu: [{label: 'All', value: -1}, 10, 25, 50],

                    order: {idx: 1, dir: 'asc'},
                    columns: [

                        {
                            title: 'Included',
                            'render': function (data, type, full, meta) {
                                var cid = full[4]
                                var x = '<input class="distListCB" type="checkbox" name="distListMember_' + cid + '" id="distListMember_' + cid + 'Y" value="' + cid + '" checked>'

                                return x;
                            }
                        },
                        {title: 'Customer First'},
                        {title: 'Customer Last'},
                        {title: 'Email'},
                        {
                            title: '',
                            'render': function (data, type, full, meta) {
                                var cid = full[4]
                                var cnm = full[1] + ' ' + full[2]
                                var x = '<button type="button" class="btn btn-sm btn-primary" onclick="customerViewFromDistList(\'' + cid + '\')" name=customerViewButton title="Update Customer: ' + cnm + '">' + cnm + '</button>'
                                return x;
                            }
                        },
                    ],
                    columnDefs: [],
                    data: tbData,
                });
            }
            document.getElementById('distributionFormDIV').scrollIntoView(true)
            $("#distListID").val(id)
            $("#distListName").val(nm)
        }

        function distListEmails(sep) {
            var table = $('#distMembersDatatable').DataTable()
            var data = table.rows().data();
            if (debug == 'Y') console.log(data)
            var x = []

            for (var i = 0; i < data.length; i++) {
                var row = data[i]
                if (row[0] == 'Y' && row[3] && row[3] != 'NONE') x.push(row[3])
            }
            var xx = x.join(sep)
            if (debug == 'Y') console.log(xx)
            copyTextToClipboard(xx)
            var m = 'Copied to clipboard:<br><br>' + xx.replaceAll(sep, sep + '<br>')
            modalMessage('Email List', m, 'bg-primary')
        }

        function customerViewFromDistList(custId) {
            var ch = customerData  [custId]
            if (ch) customerView([custId], 'distributionFormDIV')
        }

        function customerUpdate() {
            var form = document.getElementById('customerUpdateForm')

            $('#customerOutputDIV').hide()

            var custID = $('#custID').val()
            if (custID) {
                $('#customerFormHeader').html('Update Customer')
                $('.customerUpdateRow').show()
                $('.customerUpdateFields').show()
                $('.customerAddFields').hide()
                $(".custAddRequired").removeAttr("required");

            } else {
                $('#customerFormHeader').html('Add Customer')
                $('.customerUpdateRow').hide()
                $('.customerUpdateFields').hide()
                $('.customerAddFields').show()
                $('.custAddRequired').attr("required", "required")
                $('#city').val('').selectpicker("refresh")
                $('#country').val('').selectpicker("refresh")
                $('#stateInput').val('').selectpicker("refresh")
                $('#stateDD').val('').selectpicker("refresh")
                changeProject('')
            }

            var a = $('.custAddRequired')
            requiredMark('customerUpdateForm')
            var x = $('#customerUpdateForm')
            $('.customerViewFields').hide()
            $('#customerUpdateForm').removeClass("bg-readonly");

            $("#customerUpdateForm input").removeAttr("readonly");
            $("#customerUpdateForm input").removeAttr("disabled");

            var firstName = $('#firstName')
            $('#firstName').focus()
        }

        function customerView(row, returnTo) {
            if (debug == 'Y') console.log('customerView row:' + row)
            if (!row) row = ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
            if (returnTo) viewCustomerReturn = returnTo
            $('#customerFormHeader').html('View Customer')
            var custID = row[0]
            var currCustInteractions = [], currCustNextActions = [], chash = {}, custCourseHistoryData = [], cdh = []
            if (custID) {
                $('#dlCustID').val(custID)
                var cust = customerData  [custID]
                chash = cust
                if (debug == 'Y') console.log(JSON.stringify(chash))


                if (chash.cuDistLists) cdh = chash.cuDistLists.split(',')
            }

            var dh = ''
            var id = 'id="distList"'
            for (var i = 1; i < distLists.length; i++) {
                var row = distLists[i]
                var id = row[0]
                var nm = row[1]
                var checked = ''
                if (cdh.indexOf(id) >= 0) checked = 'checked'
                var l = '<div class="checkbox-inline"><input class="form-check-input" type="checkbox" name="distList" ' + id + ' value="' + id + '" ' + checked + '><label class="form-check-label" >' + nm + '</label></div>'

                dh += l + '\n'
                id = ''

            }
            $('#distListsDIV').html(dh)

            $("#customerUpdateForm input").attr("readonly", "readonly");
            $("#customerUpdateForm input").attr("disabled", "disabled");
            $("#customerClose").removeAttr("readonly").removeAttr("disabled");


            if (!custID) {
                $('#customerExistingDIV').hide()

                openSection('customerFormDIV')
                $('#dlCustID').val('')
                $('#custID').val('')
                $('#firstName').val('')
                $('#lastName').val('')
                $('#nameLikes').val('')
                $('#email').val('')
                $('#custUpdated').html('')
                $('#otherUpdated').html('')
                $('#lastParticipation').val('')
                $('#lastParticipationComment').val('')
                $('#customerSource').html('')
                $('#HomePhone').val('')
                $('#MobilePhone').val('')
                $('#WorkPhone').val('')
                $('#bestTime').val('')
                $('.custAddRequired').val('')
                customerUpdate(custID)
                $(".navbarExisting").hide()
                $("#custnavbar").show()
                $('#firstName').focus()

                return
            }

            $("#custnavbar").show()
            $("#navbarExisting").show()

            $('#customerExistingDIV').show()
            custCourseHistoryData = cust['courseHistory']
            var nm = chash.First + ' ' + chash.Last

            $('#customerFormHeader').html('View Customer')
            for (var i = 0; i < interactionDataOriginal.length; i++) {
                var row = interactionDataOriginal[i]
                var cid = row[0]
                if (cid == custID) {
                    currCustInteractions.push(row)
                }
            }
            for (var i = 0; i < nextactionDataOriginal.length; i++) {
                var row = nextactionDataOriginal[i]
                var cid = row[0]
                if (cid == custID) {
                    currCustNextActions.push(row)
                }
            }
            $('#customerUpdateForm').addClass("bg-readonly")

            if (userH.Role != 'View') {
                $('.customerViewFields').show()
                $('#customerDistListForm').removeClass("bg-readonly");
                $("#customerDistListForm input").removeAttr("readonly");
                $("#customerDistListForm input").removeAttr("disabled");
            } else {
                $('#customerDistListForm').addClass("bg-readonly");
                $("#customerDistListForm input:checkbox").attr("readonly", "readonly");
                $("#customerDistListForm input:checkbox").attr("disabled", "disabled");
            }
            $('.customerUpdateFields').hide()

            $('#custID').val(custID)
            $('#dlCustID').val(custID)
            $('#firstName').val(chash.First)
            $('#lastName').val(chash.Last)
            $('#nameLikes').val(chash.Likes)
            $('#email').val(chash.Email)
            var lu = ''
            if (chash.UpdateDate) lu = 'Last Updated: ' + chash.UpdateDate + ' by ' + chash.UpdateID + '<br>'
            lu += 'Data Source: ' + chash.source
            $('#custUpdated').html(lu)
            var lc = ''
            if (chash.cuUpdateDate) lc = 'Last Updated: ' + chash.cuUpdateDate + ' by ' + chash.cuUpdateID + '<br>'
            $('#otherUpdated').html(lc)
            $('#lastParticipation').val(chash.cuLastParticipationDate)
            $('#lastParticipationComment').val(chash.cuLastParticipationComment)
            $('#customerSource').val(chash.source)
            $('#HomePhone').val(chash['Home Phone'])
            $('#MobilePhone').val(chash['Mobile Phone'])
            $('#WorkPhone').val(chash['Work Phone'])
            $('#bestTime').val(chash['Best Time To Call'])
            $('#city').val(chash.City)
            $('#state').val(chash.State)
            $('#country').val(chash.Country)


            var cdtb = $('#custInteractions').DataTable()
            cdtb.clear().rows.add(currCustInteractions).draw();
            cdtb.column(0).visible(false);
            cdtb.column(7).visible(true);


            var ndtb = $('#custNextActions').DataTable()
            ndtb.clear().rows.add(currCustNextActions).draw();
            ndtb.column(0).visible(false);

            var chdtb = $('#custCourseHistory').DataTable()
            chdtb.clear().rows.add(custCourseHistoryData).draw();

            var cols = 'LISA,wisdom,lastPAMcourse'.split(',')
            var colNames = 'LISA ID,Wisdom,Newest PAM Course'.split(',')
            var a = []

            a.push(chash.source + ' ID: ' + custID);
            for (var i = 0; i < cols.length; i++) {
                var c = cols[i]
                var h = colNames[i]
                if (chash[c]) {
                    if (c == 'wisdom') {
                        a.push(h + ': ' + chash.lastWisdomDate + ' ' + chash[c]);
                    } else if (c == 'lastPAMcourse') {
                        a.push(h + ': ' + chash.lastPAMcourseDt + ' ' + chash[c]);
                    } else {
                        a.push(h + ': ' + chash[c]);
                    }
                }
            }
            var xx = a.join(',&nbsp;&nbsp;&nbsp;')
            console.log(xx)
            $('#custOtherInfo').html(xx)

            processRole()

            $('.customerAddFields').hide()
            openSection('customerFormDIV')
            $('#firstName').focus()

        }

        function customerSetup() {
            if (debug == 'Y') console.log('customerSetup ')
            var custByNameH = {}
            var keys = Object.keys(customerData)
            for (var i = 0; i < keys.length; i++) {
                var id = keys[i]
                var row = customerData[id]
                var ch = row
                var nm = customerName(ch)
                if (ch.Email) nm += ' [' + ch.Email + ']'
                custByNameH[nm] = id
            }
            var output = '<option value="">Select One</option>'
            var keys = Object.keys(custByNameH).sort()
            for (var i = 0; i < keys.length; i++) {
                var nm = keys[i]
                var id = custByNameH[nm]
                output += '<option value="' + id + '">' + nm + '</option>\n'
            }
            $('select.customerDropdown').html(output)
            if (debug == 'Y') console.log(output)
        }

        function custAddNextAction(custId) {
            var cntx = $('#custNextActionCount').val()
            var cntN = parseInt(cntx) + 1
            if (cntN == 3) $('#custNextActionButton').hide()
            if (cntN > 3) {
                modalMessage('Error', 'Maximun of 3 "Next Actions" can be defined for this interaction.')
                return
            }
            var cnt = cntN.toString()
            $('#custNextActionCount').val(cnt)

            var x = $('#custNextAction_' + cnt)
            $('#custNextAction_' + cnt).show()
            var a = $('#custNextAction_' + cnt + ' .cncRequired').attr("required", "required");
            requiredMark("custNextAction_" + cnt)
            datePickerSetup()

            var pipeline = $('#iapipeline').val()
            if (pipeline) {
                $('#custNextAction_pipeline_' + cnt).val(pipeline)
                $('#custNextAction_pipeline_' + cnt).selectpicker("refresh")
            }


        }

        function interactionGetRelatedNextActions(id) {
        }

        function mainTableVisibile(button) {
            if (debug == 'Y') console.log('mainTableVisibile:' + button.innerText)
            if (button.innerText == 'Hide Interactions') {
                button.innerText = 'Show Interactions'
                $('#mainInteractionCOL').hide()
                $('#mainNextActionCOL').removeClass('col-sm-6').addClass('col-sm')
            } else if (button.innerText == 'Show Interactions') {
                button.innerText = 'Hide Interactions'
                $('#mainInteractionCOL').show()
                $('#mainNextActionCOL').removeClass('col-sm').addClass('col-sm-6')
            }
            if (button.innerText == 'Hide Next Actions') {
                button.innerText = 'Show Next Actions'
                $('#mainNextActionCOL').hide()
                $('#mainInteractionCOL').removeClass('col-sm-6').addClass('col-sm')
            } else if (button.innerText == 'Show Next Actions') {
                button.innerText = 'Hide Next Actions'
                $('#mainNextActionCOL').show()
                $('#mainInteractionCOL').removeClass('col-sm').addClass('col-sm-6')
            }
        }

        function nextactionCompleted(button) {
            if (debug == 'Y') console.log('nextactionCompleted:' + button.innerText)
            if (button.innerText == 'Hide Completed') {
                button.innerText = 'Show Completed'
                nextactiondatatable.column(7).search('^$', true, false).draw()
            } else {
                button.innerText = 'Hide Completed'
                nextactiondatatable.column(7).search('.*', true, false).draw()
            }
        }

        function interactionEdit(row) {


            if (debug == 'Y') console.log('interactionEdit:' + row)

            if (!row) return

            interactionAdd(row[0], row[2])
            $('#interactionID').val(row[1])

            $('[name="intType]').removeAttr('checked');
            $("input[name=intType][value='" + row[4] + "']").prop('checked', true);

            $('[name="customerInitiated]').removeAttr('checked');
            $("input[name=customerInitiated][value='" + row[7] + "']").prop('checked', true);

            $('#intWhen').val(row[3])
            $('#intDetails').val(row[5])
            $('#leadSource').val(row[8])


            $('#interactionCustID').focus()
        }

        function interactionAdd(custID, pipeline) {

            if (debug == 'Y') console.log('interactionAdd cust:' + custID + ' pipeline:' + pipeline)

            var v = $('#customerFormDIV').is(':visible')
            if (debug == 'Y') console.log('customerFormDIV visible:' + v)
            if (!custID && v) {
                custID = $('#custID').val()
                if (debug == 'Y') console.log('interactionAdd cust:' + custID + ' pipeline:' + pipeline)
            }

            var form = document.getElementById('interactionForm')
            $('#interactionOutputDIV').hide()
            $('#interactionID').val('')
            form.reset()
            form.classList.remove('was-validated');
            if (custID) {
                $('#interactionCustID').val(custID)
                $('#interactionCustID').selectpicker("refresh")
            } else {
                $('#interactionCustID').val('')
            }
            if (pipeline) {
                $('.pipelineDropdown').val(pipeline)
            } else {
                $('.pipelineDropdown').val('')
            }
            $('.myselect').selectpicker('refresh')
            $('#custNextActionCount').val('0')
            var ac = $('.custNextActionCard').hide()
            var ar = $('.cncRequired').removeAttr('required')
            requiredMark('addInteractionMainDIV')


            $('#addInteractionModal').modal('show');
            $('#interactionCustID').focus()
        }

        function requiredRemove(id) {
            $('#' + id).removeAttr('required');
            var label = $("label[for='" + e.id + "']");
            label.id = e.id + 'LABEL'
            if (label) {
                $('#' + label.id + ' span').remove();
            }
        }

        function requiredMark(divName) {
            var a = $("#" + divName).find("select, textarea, input");
            for (var i = 0; i < a.length; i++) {
                var e = a[i]
                var req = e.required
                var nm = e.name
                var id = e.id
                var labels = $('#' + divName + " label[for='" + e.id + "']")
                if (labels.length > 0 && req) {
                    var label = labels[0]
                    var x = label.innerText
                    if (x.indexOf('*') < 0) {
                        $(label).append($("<span>", {"class": "required-indicator"}).text(" *"));
                        if (debug == 'Y') console.log('added required to ' + id)
                    } else {
                        if (debug == 'Y') console.log('NOT added required to ' + id)
                    }
                }
            }
        }

        function requiredList(divName) {
            if (debug == 'Y') console.log('--- Required fields in ' + divName)
            var a = $("#" + divName).find("select, textarea, input");
            for (var i = 0; i < a.length; i++) {
                var e = a[i]
                var req = e.required
                var nm = e.name
                var id = e.id
                var x = id + ' ' + nm
                var labels = $("label[for='" + e.id + "']");
                if (labels.length > 0) {
                    var label = labels[0]
                    x += ' ' + label.innerText
                }
                if (req) {
                    if (debug == 'Y') console.log('required ' + x)
                } else {
                    if (debug == 'Y') console.log('NOT required ' + x)
                }
            }
        }

        function requiredCheck(formId, messageDIV) {
            if (debug == 'Y') console.log('----- required check')
            var form = document.getElementById(formId)
            if (form.checkValidity() === false) {
                form.classList.add('was-validated');
                form.reportValidity();
                if (messageDIV) {
                    removeClassesByPrefix('#' + messageDIV, 'bg-')
                    $('#' + messageDIV).addClass('bg-warning').html('Validation Failed, please correct fields highlighted in red').show()
                }
                return 'failed'
            } else {
                form.classList.remove('was-validated');
                $('#' + messageDIV).hide()
                return ''
            }
        }

        function requiredCheckzzzzz(formId) {
            var form = document.getElementById(formId)
            var msg = ''
            $("#" + formId).find("select, textarea, input").removeClass('border-danger');
            if (form.checkValidity() === false) {
                for (var i = 0; i < a.length; i++) {
                    var e = a[i]
                    var req = e.required
                    var nm = e.name
                    var id = e.id
                    var labels = $("label[for='" + e.id + "']");
                    if (req) {
                        if (labels.length > 0) {
                            var labelE = labels[0]
                            var label = labels[0].innerText.replace('*', '')
                            msg += label + ' is required<br>'

                            $(labelE).addClass('bg-warning');
                        } else {
                            if (debug == 'Y') console.log('requiredCheck:' + nm + ' ' + id + ' no label')
                        }
                    }
                }
            }
            return msg
        }

        function nextactionAdd(custID, pipeline) {
            if (debug == 'Y') console.log('nextactionAdd cust:' + custID + ' pipeline:' + pipeline)

            var v = $('#customerFormDIV').is(':visible')
            if (!custID && v) {
                custID = $('#custID').val()
                if (debug == 'Y') console.log('nextactionAdd cust:' + custID + ' pipeline:' + pipeline)
            }

            var form = document.getElementById('nextactionForm')
            $('#interactionOutputDIV').hide()
            form.reset()
            form.classList.remove('was-validated');
            requiredMark('addnextactionModal')

            if (custID) {
                $('#nextactionCustID').val(custID)
                $('#nextactionCustID').selectpicker("refresh")
            } else {
                $('#nextactionCustID').val('')
            }
            if (pipeline) {
                $('.pipelineDropdown').val(pipeline)
            } else {
                $('.pipelineDropdown').val('')
            }
            $('#date').val('')
            $('#nawho').val('')
            $('#completedate').val('')
            $('#nextActionDetails').val('')

            $('.myselect').selectpicker('refresh')

            requiredMark('addNextactionModal')
            $('#addnextactionModal').modal('show');
            $('#nextactionCustID').focus()
        }

        function nextactionEdit(row) {
            if (debug == 'Y') console.log('nextactionAdd:' + row)
            var form = document.getElementById('nextactionForm')
            $('#interactionOutputDIV').hide()
            form.reset()
            form.classList.remove('was-validated');
            requiredMark('addnextactionModal')

            var a = $("input[name=lead]")
            $("input[name=lead]").prop("checked", false);
            if (row) {
                $('#nextactionCustID').val(row[0])
                $('#nextActionID').val(row[0])
                $('.pipelineDropdown').val(row[2])
                var b = $("input[name=lead][value='" + row[4] + "']").prop("checked", true);
                $('#date').val(row[3])
                $('#nawho').val(row[6])
                $('#completedate').val(row[7])
                $('#nextActionDetails').val(row[5])
            } else {
                $('#nextactionCustID').val('')
                $('#nextActionID').val('')
                $('.pipelineDropdown').val('')
                $('#date').val('')
                $('#nawho').val('')
                $('#completedate').val('')
                $('#nextActionDetails').val('')
            }
            $('.myselect').selectpicker('refresh')

            requiredMark('addNextactionModal')
            $('#addnextactionModal').modal('show');
            $('#nextactionCustID').focus()
        }

        function arrayToTable(a, hdrs=false, cols) {
            if (!cols) cols = a[0].length
            var h = '<table  class="table">\n'
            for (var i = 0; i < a.length; i++) {
                var row = a[i]
                h += '<tr>'
                for (var j = 0; j < cols; j++) {
                    var v = row[j]
                    if (!v) v = ''
                    if (hdrs && i == 0) {
                        h += '<th>' + v + '</th>'
                    } else {
                        h += '<td>' + v + '</td>'
                    }

                }
                h += '</tr>\n'
            }
            h += '</table>'
            return h

        }

        function popoverSetup() {
            $.fn.popover.Constructor.Default.whiteList.table = [];
            $.fn.popover.Constructor.Default.whiteList.tr = [];
            $.fn.popover.Constructor.Default.whiteList.td = [];
            $.fn.popover.Constructor.Default.whiteList.th = [];
            $.fn.popover.Constructor.Default.whiteList.div = [];
            $.fn.popover.Constructor.Default.whiteList.tbody = [];
            $.fn.popover.Constructor.Default.whiteList.thead = [];
            $.fn.popover.Constructor.Default.whiteList.button = [];

            var copyButton = '<span class="btn btn-info btn-xs">Copy</span>'

            $('.pop').each(function () {
                var $elem = $(this);
                $elem.popover({
                    placement: 'auto',
                    trigger: 'hover',
                    html: true,
                    container: $elem,
                    animation: true,

                    content: function () {
                        var result = $();
                        var ar = $(this).data("message").split(',')
                        var item = ar[0]
                        var id = ar[1]
                        var ty = ar[ar.length - 1]
                        var h = ''
                        if ((item == 'cust')) {
                            var cols = 'Home Phone,Work Phone,Mobile Phone,Email,Best Time To Call,cuLastParticipationDate,cuLastParticipationComment,LISA,wisdom,lastPAMcourse,cuUpdateDate,UpdateDate'.split(',')
                            var colNames = 'Home Phone,Work Phone,Mobile Phone,Email,Best Time To Call,Last Participation Date,Last Participation Comment,LISA ID,Wisdom,Newest PAM Course,Customer Updated,Other Info Updated'.split(',')
                            var cd = customerData[id]
                            var c = cd

                            if (debug == 'Y') console.log(c)

                            var a = []

                            a.push([cd.source + ' ID: ', id]);
                            var addr = c['City'] + ', ' + c['State'] + ' ' + c['Country']
                            a.push(['Location: ', addr]);
                            for (var i = 0; i < cols.length; i++) {
                                var c = cols[i]
                                var h = colNames[i]
                                if (cd[c]) {
                                    if (c == 'wisdom') {
                                        a.push([h + ': ', cd.lastWisdomDate + ' ' + cd[c]], '');
                                    } else if (c == 'cuUpdateDate') {
                                        a.push([h + ': ', cd[c] + ' by ' + cd.cuUpdateID]);
                                    } else if (c == 'UpdateDate') {
                                        a.push([h + ': ', cd[c] + ' by ' + cd.UpdateID]);
                                    } else if (c == 'lastPAMcourse') {
                                        a.push([h + ': ', cd.lastPAMcourseDt + ' ' + cd[c]]);
                                    } else if (c.indexOf('Phone') >= 0) {
                                        var v = cd[c]
                                        v = '<a href="tel:' + v + '">' + v + '</a>';
                                        a.push([h + ': ', v, copyButton]);
                                    } else if (c == 'Email') {
                                        var v = cd[c]
                                        if (v.trim() == '') {
                                            v = '<span class="text-danger"  >*** Email is empty ***</span>'
                                        } else if (validateEmail(v)) {
                                            if (debug == 'Y') console.log('populateForm valid email:' + v + ':')
                                            v = '<a href="mailto:' + v + '">' + v + '</a>';
                                        } else {
                                            if (debug == 'Y') console.log('populateForm invalid email:' + v + ':')
                                            v += '<span class="text-danger"  > *** Invalid Email ***</span>'
                                        }

                                        a.push([h + ': ', v, copyButton]);
                                    } else {
                                        a.push([h + ': ', cd[c]]);
                                    }
                                } else {
                                    if (c == 'Email') {
                                        var v = '<span class="text-danger"  >*** Email is empty ***</span>'
                                        a.push([h + ': ', v]);
                                    }
                                }
                            }
                            h = arrayToTable(a, 0, 3)
                            h += '<button type="button" class="btn btn-sm btn-primary " name="customerViewButton" >View Customer</button>'
                            var m = '<div class="popover-message">\n' + h + '</div>';
                            if (debug == 'Y') console.log(m)
                            return m
                        } else if ((item == 'interaction')) {

                            var row = interactionById[id]
                            var a = []
                            a.push(['ID: ', row[1]]);
                            a.push(['Pipeline: ', row[2]]);
                            a.push(['When: ', row[3]]);
                            a.push(['Type:', row[4]]);
                            a.push(['Details: ', row[5]]);
                            a.push(['Who: ', row[6]]);
                            a.push(['Customer Initiated: ', row[7]]);
                            a.push(['Lead Source: ', row[8]]);
                            a.push(['Last Updated:', row[9]]);
                            a.push(['Last Updated By:', row[10]]);
                            h = arrayToTable(a, 0)
                            if (userH.Role == 'Admin' || (userH.Role == 'Edit' && userH.Email == row[9])) {
                                h += '<br><button type="button" class="btn btn-sm btn-success" name="editInteractionButton" title="Edit Interaction" >Edit</button>'
                            }
                            var m = '<div class="popover-message">\n' + h + '</div>';


                            if (debug == 'Y') console.log(m)
                            return m
                        } else if ((item == 'nextaction')) {

                            var row = nextactionById[id]
                            var a = []
                            a.push(['ID: ', row[1]]);
                            a.push(['Pipeline: ', row[2]]);
                            a.push(['Date Due: ', row[3]]);
                            a.push(['Lead Priority: ', row[4]]);
                            a.push(['Details: ', row[5]]);
                            a.push(['Person Responsible: ', row[6]]);
                            a.push(['Completed: ', row[7]]);

                            a.push(['Last Updated:', row[8]]);
                            a.push(['Last Updated By:', row[9]]);
                            h = arrayToTable(a, 0)
                            if (userH.Role == 'Admin' || (userH.Role == 'Edit' && userH.Email == row[9])) {
                                h += '<br><button type="button" class="btn btn-sm btn-success" name="editNextactionButton" title="Edit Next Action" >Edit</button>'
                                if (row[7] == '') {
                                    h += '&nbsp;&nbsp;&nbsp;<button type="button" class="btn btn-sm btn-warning" name="markCompleteNextactionButton" title="Mark Next Action Complete" >Mark Complete</button>'
                                }
                            }
                            var m = '<div class="popover-message">\n' + h + '</div>';


                            if (debug == 'Y') console.log(m)
                            return m
                        }
                    }
                });
            });
        }

        /*        $(function () {
                    datePickerSetup()
                    popoverSetup()
                    $(document).click(function (e) {
                        var t = $(event.target).text()
                        if (debug == 'Y') console.log('reset all popovers on any click t:' + t)
                        if (t == 'Copy') {
                            var cell = $(event.target).closest('td')
                            var txt = $(event.target).closest('td').prev()[0].innerText
                            if (debug == 'Y') console.log('copy txt:' + txt)
                            copyTextToClipboard(txt)
                        } else if (!$(e.target).is('.popup-marker, .popover-title, .popover-content')) {
                            $('.popup-marker').popover('hide');
                        }
                    });

                });
          */
        function validateEmail(email) {

            if (/^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w+)+$/.test(email)) {
                return (true)
            }
            return (false)
        }

        function copyTextToClipboard(txt) {

            const textarea = document.createElement('textarea')
            textarea.id = 'temp_element'

            textarea.style.height = 0

            document.body.appendChild(textarea)

            textarea.value = txt

            const selector = document.querySelector('#temp_element')
            selector.select()
            document.execCommand('copy')

            if (debug == 'Y') console.log('copyTextToClipboard:' + txt)
            document.body.removeChild(textarea)
        }

        function googleCallBefore(msg) {
            $('.modal').modal('hide');
            if (!msg) msg = 'Updating, please wait ...'
            $('#inProgressMessage').html(msg);
            $('#inProgress').show();
            $('#mainDiv').hide();
            googleDate = new Date()
        }

        function googleCallAfter() {
            elapsedTime(googleDate, 'after google call')
            $('#inProgress').hide();
            $('#mainDiv').show();
        }

        function submitSupport(formObjectIn) {
            var formObject = {userH: userH}

            formObject.supportInfo = document.getElementById('supportInfo').value;
            formObject.supportType = document.querySelector('input[name="supportType"]:checked').value
            formObject.userAgent = window.navigator.userAgent
            formObject.env = env

            $('#supportRequestMessage').html('').hide()
            googleCallBefore()
            console.log('calling     google.script.run.withSuccessHandler(afterSubmitSupport).submitSupport(formObject)')
            try {
                google.script.run.withSuccessHandler(afterSubmitSupport).submitSupport(formObject);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {"msg": "no google", "rc": 0}

                    afterSubmitSupport(ret)
                }
            }

        }

        function afterSubmitSupport(res) {
            if (debug == 'Y') console.log('afterSubmitSupport:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res)
            if (res.rc) {
                document.getElementById("supportForm").reset();
                closeSection('supportRequestDIV')
            }
        }

        function customerList() {
            viewCustomerReturn = 'customersDIV'
            openSection('customersDIV')

        }

        function customerSearchTypeChange(v) {
            if (debug == 'Y') console.log('customerSearchTypeChange:' + v)
            if (v == 'Email') {
                $('#customersSearchName').hide()
                $('#customersSearchEmail').show()
            } else {
                $('#customersSearchName').show()
                $('#customersSearchEmail').hide()
            }
        }

        function customerSearch(formObject) {
            if (debug == 'Y') console.log('customerSearch:' + $('#' + formObject.id).serialize())
            var msg = requiredCheck(formObject.id, 'customerSearchMessage')
            if (msg) {
                return false
            }

            var st = $('input[name=searchType]:radio:checked').val()
            if (st == 'Email') {
                var content = $('#contentEmail').val()
            } else {
                var content = $('#contentFirst').val() + $('#contentLast').val()
            }
            if (content.length < 3) {
                if (st == 'Email') {
                    $('#contentEmail').addClass('is-invalid');
                } else {
                    $('#contentFirst').addClass('is-invalid');
                    $('#contentLast').addClass('is-invalid');
                }
                $('#customerSearchMessage').addClass('bg-warning').html('Validation Failed: Content requires at least 3 characters').show()
                return false
            }
            $('#contentEmail').removeClass('is-invalid');
            $('#contentFirst').removeClass('is-invalid');
            $('#contentLast').removeClass('is-invalid');

            removeClassesByPrefix('#customerSearchMessage', 'bg-')
            $('#customerSearchMessage').html('').hide()
            googleCallBefore('Retrieving, please wait (may take 10 to 20 seconds) ...')
            console.log('calling google.script.run.withSuccessHandler(afterCustomerSearch).customerSearch(formObject)')
            try {
                google.script.run.withSuccessHandler(afterCustomerSearch).customerSearch(formObject);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {
                        "msg": "Returned 2", "rc": 1, "hout": {
                            "14912": {
                                "courses": "BOW,CAM,CGT,DCRR,PEX,PLD,SEO,TYS,WAC,WIS,YE,YEAT,YELE",
                                "lastPAMcourseDt": "2023-05-19",
                                "Email": "leefaroe@yahoo.com",
                                "WorkPhone": "",
                                "LISA": "6269365",
                                "lastWisdomDate": "",
                                "lastPAMcourse": "Conference for Global Transformation",
                                "source": "PAM",
                                "City": "San Diego",
                                "coursHistory": [["14912", "227", "REGFF", "WIS", "Wisdom Unlimited", "Atlanta", "2017-03-17T00:00:00", "REV", "2017-03-17"], ["14912", "232", "REGFF", "WIS", "Wisdom Unlimited", "San Diego", "2017-03-24T00:00:00", "REV", "2017-03-24"], ["14912", "243", "REGFF", "YE", "Year-end Vacation", "Riviera Maya, Mexico", "2017-12-02T00:00:00", "STD", "2017-12-02"], ["14912", "298", "REGFF", "WIS", "Wisdom Unlimited", "San Diego", "2018-07-27T00:00:00", "REV", "2018-07-27"], ["14912", "308", "REGFF", "YE", "Year-end Vacation", "Riviera Maya, Mexico", "2018-12-01T00:00:00", "STD", "2018-12-01"], ["14912", "342", "REGFF", "YEAT", "Year-end Vacation Assisting Team", "Wisdom Central Office", "2022-11-01T00:00:00", "WD", "2022-11-01"], ["14912", "353", "REGFF", "TYS", "Transforming Yesterday's Strategies", "Puerto Vallarta", "2019-08-02T00:00:00", "STD", "2019-08-02"], ["14912", "360", "REGFF", "YE", "Year-end Vacation", "Los Cabos, Mexico", "2019-12-02T00:00:00", "STD", "2019-12-02"], ["14912", "404", "REGFF", "DCRR", "Developmental Course on Relating and Relationships", "Web (Online)", "2020-04-24T00:00:00", "WD", "2020-04-24"], ["14912", "438", "REGFF", "BOW", "A Bit of Wisdom", "San Diego", "2020-04-25T00:00:00", "WD", "2020-04-25"], ["14912", "440", "REGFF", "BOW", "A Bit of Wisdom", "Denver", "2020-05-02T00:00:00", "WD", "2020-05-02"], ["14912", "483", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2021-05-21T00:00:00", "STD", "2021-05-21"], ["14912", "505", "REGFF", "SEO", "Structural Explorations Online", "Web (Online)", "2021-11-01T00:00:00", "STD", "2021-11-01"], ["14912", "510", "REGFF", "CAM", "Center Assisting Meeting", "North America / Australia", "2021-03-12T00:00:00", "P", "2021-03-12"], ["14912", "515", "REGFF", "PLD", "Program Leader Day", "Web (Online)", "2021-05-26T00:00:00", "P", "2021-05-26"], ["14912", "587", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2023-05-19T00:00:00", "STD", "2023-05-19"], ["14912", "332", "PEXPM", "PEX", "Partnership Explorations", "Los Angeles", "2019-06-22T00:00:00", "P", "2019-06-22"], ["14912", "135", "REGFF", "WIS", "Wisdom Unlimited", "Atlanta", "2015-03-13T00:00:00", "STD", "2015-03-13"], ["14912", "161", "REGFF", "YE", "Year-end Vacation", "Guanacaste, Costa Rica", "2015-12-05T00:00:00", "STD", "2015-12-05"], ["14912", "198", "REGFF", "YE", "Year-end Vacation", "Puerto Los Cabos, Mexico", "2016-12-03T00:00:00", "STD", "2016-12-03"], ["14912", "203", "REGFF", "WAC", "WCA Assisting Conference", "San Francisco", "2016-05-23T00:00:00", "R", "2016-05-23"], ["14912", "332", "REGFF", "PEX", "Partnership Explorations", "Los Angeles", "2019-06-22T00:00:00", "STD", "2019-06-22"], ["14912", "410", "REGFF", "YE", "Year-end Vacation", "Panama City, Panama", "2020-11-30T00:00:00", "WD", "2020-11-30"], ["14912", "485", "REGFF", "YELE", "Year-end Vacation Launch Event", "Web (Online)", "2020-10-24T00:00:00", "P", "2020-10-24"], ["14912", "519", "REGFF", "CGT", "Conference for Global Transformation", "Web (Online)", "2022-05-20T00:00:00", "WD", "2022-05-20"]],
                                "MobilePhone": "404-825-9436",
                                "wisdom": "N",
                                "Last": "Roe",
                                "HomePhone": "",
                                "ChangeType": "",
                                "State": "CA",
                                "customerID": 14912,
                                "Country": "US",
                                "First": "Leefa",
                                "row": [14912, "Roe", "Leefa", "Leefa", "San Diego", "CA", "US", "", "", "404-825-9436", "leefaroe@yahoo.com", "", "", "", "6269365", "PAM"],
                                "BestTime": "",
                                "Likes": "Leefa"
                            },
                            "24857": {
                                "courses": "",
                                "lastPAMcourseDt": "",
                                "Email": "lroe@landmarkworldwide.com",
                                "WorkPhone": "",
                                "LISA": "",
                                "lastWisdomDate": "",
                                "lastPAMcourse": "",
                                "City": "",
                                "source": "PAM",
                                "coursHistory": [],
                                "MobilePhone": "",
                                "wisdom": " ",
                                "Last": "Roe",
                                "HomePhone": "",
                                "ChangeType": "",
                                "State": "",
                                "customerID": 24857,
                                "Country": "",
                                "First": "Leefa",
                                "BestTime": "",
                                "row": [24857, "Roe", "Leefa", "", "", "", "", "", "", "", "lroe@landmarkworldwide.com", "", "", "", "", "PAM"],
                                "Likes": ""
                            }
                        }
                    }

                    afterCustomerSearch(ret)
                }
            }
        }

        function afterCustomerSearch(res) {
            if (debug == 'Y') console.log('afterCustomerSearch:' + JSON.stringify(res))

            googleCallAfter()
            if (res.rc && res.hout) {
                var hout = res.hout
                var cust = []
                var keys = Object.keys(hout)
                for (var i = 0; i < keys.length; i++) {
                    var id = keys[i]
                    if (!customerData[id]) {
                        customerData[id] = hout[id]
                    }
                    //cust.push(hout[id].row)
                    cust.push(hout[id])
                }
                if (keys.length > 0) customerSetup()
                var cdtb = $('#customerTable').DataTable()
                cdtb.clear().rows.add(cust).draw();
                var st = $('input[name="searchType"]:checked').val();

                var st = $('input[name=searchType]:radio:checked').val()
                if (st == 'Email') {
                    var content = 'Email contains "' + $('#contentEmail').val() + '"'
                } else {
                    var content = 'First Name contains "' + $('#contentFirst').val() + '"' + 'AND Last Name contains "' + $('#contentLast').val() + '"'
                }

                $(".dbtCustomerTitle").html('<b>' + content + '</b>');
                $('#customersTableADD').show()
                $('#customersTableROW').show()
            } else {
                displayOutput(res)
                $('#customersTableADD').hide()
                $('#customersTableROW').hide()
            }
        }

        function changeProject(v) {
            if (v == '') {
                $('#stateMsg').show()
                $('#stateDD').selectpicker('hide').removeAttr("required");
                $('#stateInput').hide().removeAttr("required")
            } else if (v == 'USA') {
                $('#stateMsg').hide()
                $('#stateDD').addClass('custAddRequired').selectpicker('show').attr("required", "required")
                $('#stateInput').removeClass('custAddRequired').hide().removeAttr("required");
            } else {
                $('#stateMsg').hide()
                $('#stateDD').removeClass('custAddRequired').selectpicker('hide').removeAttr("required")
                $('#stateInput').addClass('custAddRequired').show().attr("required", "required")
            }
        }

        function customerAddSubmit(formObject) {
            var msg = requiredCheck('customerUpdateForm', 'customerOutputDIV')
            if (msg) {

                return false
            }
            var msg = requiredCheck('customerDistListForm', 'customerOutputDIV')
            if (msg) {

                return false
            }

            var hp = $('#HomePhone').val()
            var mp = $('#MobilePhone').val()
            var wp = $('#WorkPhone').val()
            if (!hp && !wp && !mp) {
                $('#HomePhone,#MobilePhone,#WorkPhone').addClass('is-invalid');
                $('#customerOutputDIV').addClass('bg-warning').html('Validation Failed, At least one phone number is required').show()
                return false
            }

            $('#customerOutputDIV').hide()
            $('#HomePhone,#MobilePhone,#WorkPhone').removeClass('is-invalid');

            var h = {distList: []}
            var form = document.getElementById("customerUpdateForm");
            var customerUpdateFormData = new FormData(form);
            for (const pair of customerUpdateFormData.entries()) {
                h[pair[0]] = pair[1]
            }
            form = document.getElementById("customerDistListForm");
            var customerDistListFormData = new FormData(form);
            console.log('---customerDistListFormData ---');
            for (const pair of customerDistListFormData.entries()) {
                if (pair[0] == 'distList') {
                    h.distList.push(pair[1])
                } else {
                    h[pair[0]] = pair[1]
                }
            }
            googleCallBefore()
            console.log('calling google.script.run.withSuccessHandler(afterCustomerSubmit).customerSubmit(h)\n' + JSON.stringify(h))
            try {
                google.script.run.withSuccessHandler(afterCustomerSubmit).customerSubmit(h);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {
                        "msg": "Customer Record Added<br><br>Other info added",
                        "rc": 1,
                        "hash": {
                            "customerID": "T000000021",
                            "Last": "add",
                            "First": "test",
                            "Likes": "",
                            "City": "Atlanta",
                            "State": "Alabama",
                            "Country": "USA",
                            "Home Phone": "",
                            "Work Phone": "",
                            "Mobile Phone": "4041231234",
                            "Email": "testadd@gmail.com",
                            "Best Time To Call": "4-6pm",
                            "UpdateDate": "2024-10-31 05:31:53 AM ",
                            "UpdateID": "WCA Support",
                            "courseHistory": [],
                            "cuDistLists": "1,2",
                            "cuLastParticipationDate": "2025-10-01",
                            "cuLastParticipationComment": "sd community gathering",
                            "cuUpdateDate": "2024-10-31 05:31:54 AM ",
                            "cuUpdateID": "WCA Support",
                            "cuComment": "added"
                        },
                        "added": 1,
                        "otherRet": {
                            "rc": 1,
                            "msg": "Other information added",
                            "hash": {
                                "customerID": "T000000021",
                                "Last": "add",
                                "First": "test",
                                "Likes": "",
                                "City": "Atlanta",
                                "State": "Alabama",
                                "Country": "USA",
                                "Home Phone": "",
                                "Work Phone": "",
                                "Mobile Phone": "4041231234",
                                "Email": "testadd@gmail.com",
                                "Best Time To Call": "4-6pm",
                                "UpdateDate": "2024-10-31 05:31:53 AM ",
                                "UpdateID": "WCA Support",
                                "courseHistory": [],
                                "cuDistLists": "1,2",
                                "cuLastParticipationDate": "2025-10-01",
                                "cuLastParticipationComment": "sd community gathering",
                                "cuUpdateDate": "2024-10-31 05:31:54 AM ",
                                "cuUpdateID": "WCA Support",
                                "cuComment": "added"
                            }
                        }
                    }
                    afterCustomerSubmit(ret)
                }
            }
        }

        function afterDummySubmit(res) {
            console.log('afterDummySubmit:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res)
        }

        function customerSubmit(formObject) {
            var msg = requiredCheck('customerUpdateForm', 'customerOutputDIV')
            if (msg) {

                return false
            }

            var hp = $('#HomePhone').val()
            var mp = $('#MobilePhone').val()
            var wp = $('#WorkPhone').val()
            if (!hp && !wp && !mp) {
                $('#HomePhone,#MobilePhone,#WorkPhone').addClass('is-invalid');
                $('#customerOutputDIV').addClass('bg-warning').html('Validation Failed, At least one phone number is required').show()
                return false
            }

            $('#customerOutputDIV').hide()
            $('#HomePhone,#MobilePhone,#WorkPhone').removeClass('is-invalid');
            googleCallBefore()
            console.log('calling google.script.run.withSuccessHandler(afterCustomerSubmit).customerSubmit(formObject)')
            try {
                google.script.run.withSuccessHandler(afterCustomerSubmit).customerSubmit(formObject);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {
                        "msg": "Record Added",
                        "rc": 1,
                        "hash": {
                            "row": ["99999", "Joe", "Johnsone", "joejohnson@gmail.com", "404-123-1234", "1,2", "2024-09-06T11:16:30.724Z", "WCA Support"],
                            "hash": {
                                "customerID": "99999",
                                "First": "Joe",
                                "Last": "Johnsone",
                                "Email": "joejohnson@gmail.com",
                                "Phone": "404-123-1234",
                                "cuDistLists": "1,2",
                                "UpdateDate": "2024-09-06T11:16:30.724Z",
                                "UpdateID": "WCA Support"
                            },
                            "courseHistory": []
                        }
                    }

                    afterCustomerSubmit(ret)
                }
            }
        }

        function afterCustomerSubmit(res) {
            if (debug == 'Y') console.log('afterCustomerSubmit:' + res)
            if (debug == 'Y') console.log('afterCustomerSubmit:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res)
            if (res.rc && res) {
                var id = res.hash.customerID
                if (customerData[id]) {
                    mergeHash(customerData[id], res.hash)
                    if (debug == 'Y') console.log('afterCustomerSubmit merged to customerData:' + JSON.stringify(customerData[id]))
                } else {
                    customerData[id] = res.hash
                    if (debug == 'Y') console.log('afterCustomerSubmit added to customerData:' + JSON.stringify(customerData[id]))
                }
                customerSetup()
                var cd = customerData[id]
                customerView([id])
            }
        }

        function customerOtherInfoSubmit(formObject) {
            var lpc = $('#lastParticipationComment').val()
            var lpdt = $('#lastParticipation').val()
            if ((lpdt && !lpc) || (!lpdt && lpc)) {
                $('#lastParticipationComment,#lastParticipation').addClass('is-invalid');
                $('#customerOutputDIV').addClass('bg-warning').html('Validation Failed, If Last Participation Date or Comment are entered, both are required').show()
                return false
            }

            $('#customerOutputDIV').hide()
            $('#lastParticipationComment,#lastParticipation').removeClass('is-invalid');

            var h = {distList: []}
            var form = document.getElementById("customerUpdateForm");
            var customerUpdateFormData = new FormData(form);
            for (const pair of customerUpdateFormData.entries()) {
                h[pair[0]] = pair[1]
            }
            form = document.getElementById("customerDistListForm");
            var customerDistListFormData = new FormData(form);
            console.log('---customerDistListFormData ---');
            for (const pair of customerDistListFormData.entries()) {
                if (pair[0] == 'distList') {
                    h.distList.push(pair[1])
                } else {
                    h[pair[0]] = pair[1]
                }
            }

            googleCallBefore()
            if (debug == 'Y') console.log('customerOtherInfoSubmit:' + JSON.stringify(h))

            console.log('calling google.script.run.withSuccessHandler(aftercustomerOtherInfoSubmit).customerOtherInfoSubmit(formObject)')
            try {
                google.script.run.withSuccessHandler(aftercustomerOtherInfoSubmit).customerOtherInfoSubmit(h)
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var ret = {
                        "msg": "Record Added",
                        "rc": 1,
                        "hash": {
                            "courseHistory": [],
                            "customerID": "C000000009",
                            "Last": "xx",
                            "First": "x",
                            "Likes": "x",
                            "City": "",
                            "State": "",
                            "Country": "",
                            "Home Phone": "4048259436",
                            "Work Phone": "",
                            "Mobile Phone": "",
                            "Email": "x@xmail.com",
                            "Best Time To Call": "4-6pm",
                            "UpdateDate": "1,6",
                            "UpdateID": "2024-10-01 08:32:48 AM ",
                            "cuDistLists": "1,6",
                            "cuLastParticipationDate": "2024-10-01",
                            "cuLastParticipationComment": "sd community gathering",
                            "cuUpdateDate": "2024-10-01 08:32:48 AM ",
                            "cuUpdateID": "WCA Support",
                            "cuComment": "added"
                        },
                        "added": 1
                    }
                    //var ret={"msg":"no google","rc":0}
                    aftercustomerOtherInfoSubmit(ret)
                }
            }
        }

        function aftercustomerOtherInfoSubmit(res) {
            if (debug == 'Y') console.log('aftercustomerOtherInfoSubmit:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res)
            if (res.rc && res.hash) {
                var id = res.hash.customerID
                if (customerData[id]) {
                    mergeHash(customerData[id], res.hash)
                } else {
                    customerData[id] = res.hash
                }
                var cd = customerData[id]
                customerView([id])
            }
        }

        function interactionFormSubmit(formObject) {
            var msg = requiredCheck('interactionForm', 'interactionOutputDIV')
            if (msg) {

                return false
            }

            googleCallBefore()
            console.log('calling google.script.run.withSuccessHandler(createTable).processForm(formObject) ')
            try {
                google.script.run.withSuccessHandler(afterInteractionFormSubmit).interactionSubmit(formObject);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var res = {msg: 'test fail', rc: 0}
                    res = {
                        "msg": "Interaction Record Added",
                        "add": 1,
                        "rc": 1,
                        "row": ["C000000021", "16", "CGT", "2024-10-03", "Guest Event", "x", "WCA Support", "No", "", "2024-10-03 03:58:00 AM ", "WCA Support"]
                    }

                    afterInteractionFormSubmit(res)
                }
            }
        }


        function afterInteractionFormSubmit(res) {
            if (debug == 'Y') console.log('afterInteractionFormSubmit:' + JSON.stringify(res))

            if (res.rc) {
                googleCallAfter()
                if (res.row) {
                    var id = res.row[1]
                    var custID = res.row[0]
                    if (res.add) {
                        interactionDataOriginal.push(res.row)
                    } else {

                        for (var i = 0; i < interactionDataOriginal.length; i++) {
                            var r = interactionDataOriginal[i]
                            if (r[1] == id) {
                                interactionDataOriginal[i] = res.row
                                if (debug == 'Y') console.log('afterInteractionFormSubmit interaction row found:' + i)
                                break
                            }
                        }
                    }
                    interactionById[id] = res.row
                    if (res.naRows) {
                        for (var i = 0; i < res.naRows.length; i++) {
                            var id = res.naRows[i][1]
                            nextactionDataOriginal.push(res.naRows[i])
                            nextactionById[id] = res.naRows[i]
                        }
                    }
                    filterData()
                    var v = $('#customerFormDIV').is(':visible')
                    if (debug == 'Y') console.log('afternextactionFormSubmit  visible:' + v)
                    if (v) {
                        customerView([custID])
                    }
                }
            } else {
                var im = $('#addInteractionModal')
                $('#addInteractionModal').modal('show');
            }
            displayOutput(res, 'interactionOutputDIV')
        }

        function nextactionFormSubmit(formObject) {
            var msg = requiredCheck(formObject.id, 'nextactionOutputDIV')
            if (msg) {
                return false
            }

            googleCallBefore()
            console.log('calling google.script.run.withSuccessHandler(createTable).processForm(formObject) ')
            try {
                google.script.run.withSuccessHandler(afternextactionFormSubmit).nextactionSubmit(formObject);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var res = {msg: 'test fail', rc: 0}

                    afternextactionFormSubmit(res)
                }
            }
        }

        function afternextactionFormSubmit(res) {
            if (debug == 'Y') console.log('afternextactionFormSubmit:' + JSON.stringify(res))

            if (res.rc) {
                googleCallAfter()
                if (res.row) {
                    var id = res.row[1]
                    var custID = res.row[0]
                    if (res.add) {
                        nextactionDataOriginal.push(res.row)
                    } else {

                        for (var i = 0; i < nextactionDataOriginal.length; i++) {
                            var r = nextactionDataOriginal[i]
                            if (r[1] == id) {
                                nextactionDataOriginal[i] = res.row
                                break
                            }
                        }
                    }
                    nextactionById[id] = res.row
                    filterData()
                    var v = $('#customerFormDIV').is(':visible')
                    if (debug == 'Y') console.log('afternextactionFormSubmit  visible:' + v)
                    if (v) {
                        customerView([custID])
                    }
                }
            } else {
                var im = $('#addNextActionModal')
                $('#addNextActionModal').modal('show');
            }
            displayOutput(res, 'interactionOutputDIV')
        }

        function nextActionMarkComplete(row) {
            if (debug == 'Y') console.log('nextActionMarkComplete:' + row)
            var naId = row[1]
            googleCallBefore()
            console.log('calling google.script.run.withSuccessHandler(createTable).processForm(formObject) ')
            try {
                google.script.run.withSuccessHandler(afternextActionMarkComplete).nextActionMarkComplete(naId);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    var res = {msg: 'test fail', rc: 0}

                    afternextActionMarkComplete(res)
                }
            }
        }

        function afternextActionMarkComplete(res) {
            if (debug == 'Y') console.log('afternextActionMarkComplete:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res)
            var custID
            if (res.rc && res.dt && res.id) {
                var id = res.id
                for (var i = 0; i < nextactionDataOriginal.length; i++) {
                    var r = nextactionDataOriginal[i]
                    if (r[1] == id) {
                        nextactionDataOriginal[i][7] = res.dt
                        custID = nextactionDataOriginal[i][0]
                        break
                    }
                }
                filterData()
                var v = $('#customerFormDIV').is(':visible')
                if (debug == 'Y') console.log('afternextActionMarkComplete visible:' + v)
                if (v) {
                    customerView([custID])
                }
            }
        }

        function displayOutput(res, messageDIV) {

            if (res.rc) {
                var title = "Submit Successful"
                $('#messageHeader').addClass('bg-success').removeClass('bg-warning');
                modalMessage(title, res.msg)
            } else {
                if (messageDIV) {
                    removeClassesByPrefix('#' + messageDIV, 'bg-')
                    $('#' + messageDIV).addClass('bg-warning').html(res.msg).show()
                } else {
                    $('#messageHeader').addClass('bg-warning').removeClass('bg-success');
                    var title = "Submit Failed"
                    modalMessage(title, res.msg)
                }
            }
        }

        function distListFormSubmit(formObject) {

            var msg = requiredCheck(formObject.id, 'distributionOutputDIV')
            if (msg) {
                return false
            }

            googleCallBefore()
            var myFields = {
                distListID: $('#distListID').val(),
                distListName: $('#distListName').val(),
                removed: [],
                user: userH.Name
            }
            var a = $(".distListCB:checkbox:not(:checked)")
            for (var i = 0; i < a.length; i++) {
                var e = a[i]
                var v = e.value
                var cd = customerData[v]
                var nm = customerName(cd)
                myFields.removed.push(v + '_' + nm)
            }
            console.log('calling google.script.run.withSuccessHandler(afterDistListSubmit).distListUpdate(formObject)\n' + JSON.stringify(myFields))
            try {
                google.script.run.withSuccessHandler(afterDistListSubmit).distListUpdate(myFields);
            } catch (e) {
                console.error(e)
                if (e.message == 'google is not defined') {
                    rh = {
                        "rc": 1,
                        "msg": "Remove customers from distribution list:Sam Smith",
                        "nameUpdated": 0,
                        "distListId": "2",
                        "distListName": "Community Gathering for CHI",
                        "removeH": {}
                    }
                    rh = {
                        "rc": 0,
                        "msg": "no google",
                    }
                    rh = {
                        "rc": 1,
                        "msg": "Customers removed from distribution list:<br>Aasa Fabricius (Aasa)<br>Ann Rice<br>",
                        "nameUpdated": 0,
                        "distListId": "1",
                        "distListName": "Community Gathering for ANZ",
                        "removeH": {"8": "2", "C000000007": "2,3,7"}
                    }

                    afterDistListSubmit(rh)
                }
            }
        }

        function afterDistListSubmit(res) {
            if (debug == 'Y') console.log('afterDistListSubmit:' + JSON.stringify(res))

            googleCallAfter()
            displayOutput(res, 'distributionOutputDIV')

            if (res.rc == 1) {
                if (res.removeH) {
                    var keys = Object.keys(res.removeH)
                    for (var i = 0; i < keys.length; i++) {
                        var cid = keys[i]
                        var dl = res.removeH[cid]
                        var cd = customerData[cid]
                        cd.cuDistLists = dl
                    }

                }
                if (res.newId) {
                    distLists.push([res.newId, res.distListName])
                }
                buildDistList()

                $('#distributionFormSelect').val(res.distListId).selectpicker('refresh')
                distributionListSelect(res.distListId, res.distListName)
            }
        }


        function searchGlobal() {
            $('table.globalsearch').DataTable().search($('#global_search').val()).draw();
        }

        function searchGlobalCustomer() {
            $('table.globalsearchCustomer').DataTable().search($('#global_search_customer').val()).draw();
        }

        function tableSearch(t, ty) {

        }

        function filterClicked(t, ty) {
            var v = t.value
            if (debug == 'Y') console.log('filterClicked v:' + v + ' ty:' + ty)
            $('#dataTableMessage').html('').hide()
            $('#filter' + ty).val(v)
            $('.' + ty).each(function () {
                var v2 = this.value
                if (v == v2) {
                    this.classList.add('btn-warning')
                    this.classList.remove('btn-info')
                } else {
                    this.classList.add('btn-info')
                    this.classList.remove('btn-warning')
                }
            });
            $('#WRmessage').html('')
            filterData()
        }

        function filterData() {
            interactionData = []
            nextactionData = []
            var filterPipeline = $('#filterPipeline').val()
            if (debug == 'Y') console.log('filter:' + filterPipeline)
            if (filterPipeline == "") {
                interactionData = interactionDataOriginal
                nextactionData = nextactionDataOriginal
            } else {
                for (var i = 0; i < interactionDataOriginal.length; i++) {
                    var row = interactionDataOriginal[i]
                    var st = row[2]
                    if (debug == 'Y') console.log(i + ':' + st)
                    if (filterPipeline && st == filterPipeline) {
                        interactionData.push(row)
                    }
                }
                for (var i = 0; i < nextactionDataOriginal.length; i++) {
                    var row = nextactionDataOriginal[i]
                    var st = row[2]
                    if (debug == 'Y') console.log(i + ':' + st)
                    if (filterPipeline && st == filterPipeline) {
                        nextactionData.push(row)
                    }
                }
            }

            interactiondatatable.clear().rows.add(interactionData).draw();
            nextactiondatatable.clear().rows.add(nextactionData).draw();
            popoverSetup()
        }

        function modalMessage(h, m, headerBG, overflow, copyToClipboardSw) {
            if (headerBG) {
                removeClassesByPrefix('#messageHeader', 'bg-')
                $('#messageHeader').addClass(headerBG);
            }

            if (!overflow) overflow = 'none'
            document.getElementById('messageMsg').style = "overflow-y: " + overflow

            $('#messageTitle').html(h);
            $('#messageMsg').html(m);
            if (copyToClipboardSw) copyToClipboard('messageMsg')
            $('#messageModal').modal('show');
            if (copyToClipboardSw) copyToClipboard('messageMsg')

            if (debug == 'Y') console.log('')

        }

        function removeClassesByPrefix(finder, prefix) {
            var a = $(finder).prop('className').split(' ')
            var pl = prefix.length
            for (var i = 0; i < a.length; i++) {
                var x = a[i] + '                                     '
                var x2 = x.substring(0, pl)
                if (x2 == prefix) {
                    $(finder).removeClass(a[i]);
                    var af = $(finder).prop('className')
                }
            }
        }

        function mergeHash(baseH, hash2) {
            var keys = Object.keys(hash2)
            for (var i = 0; i < keys.length; i++) {
                var k = keys[i]
                baseH[k] = hash2[k]
            }


        }

    </script>
    <script defer data-domain="turquoise-susanetta-75.tiiny.site" src="https://analytics.tiiny.site/js/plausible.js"></script></head>
<body>
<div id="msgDIV" class="center-block" style="display: none;"></div>
<div id="inProgress" class="center-block" style="display: none;">
    <div id="inProgressMessage">Updating, please wait</div>
    <div class="loadingio-spinner-spinner-8akhmpb2pnp ">
        <div class="ldio-hz3qtxb48e">
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>
</div>
<div class="container-fluid">
    <div id="topDIV" class="mt-2 bg-info mySection py-2" style="padding: 30px;">
        <div class="row ">
            <div id="mainHeader" class="col text-white bg-info h2">Dashboard</div>
            <div id="projectHeader" class="col text-white bg-info h2">All Projects</div>
            <div class="col-xs text-right " id="userDIV"></div>
        </div>
    </div>
    <div id="mainDiv">
        <div class="row ">
        <table border="0" style="width:100%">
            <tr ><td style="width:8%">
                <div class="custnavbar" id="custnavbar" style="display:block">

                    <button type="button" class="btn btn-secondary mynavbar mynavbarselected " onclick="navbarSelected('Projects')">Projects</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Dashboard')">Dashboard</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Budget')">Budget</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Forecast')">Forecast</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Labor Reports')">Labor Reports</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Time Data')">Time Data</button>
                    <button type="button" class="btn btn-secondary mynavbar projectSelected" onclick="navbarSelected('Project Team')">Project Team</button>
                </div>

            </td><td>


                    <div id="DashboardDIV" class="col majorSection " style="display: none">
                        <div class="row" id="DashboardRow1DIV">
                            <div class="col">
                                <div class="chart-container" >
                                    <canvas id="dashboardSummary" style="height: 150px"></canvas>
                                </div>
                            </div>
                            <div class="col" style="height: 150px">
                                <b>Profit Margin:</b> 67%<br>
                                <b>Project Dates</b> <b>Begin: </b>2024-10-11 <b>End: </b>2025-10-11 (12 months_MMM_YYYY)<br>
                            </div>
                        </div>
                        <div class="row" id="DashboardRow2DIV">
                            <div class="col border border-success rounded20 mySection mr-1">
                                <h1 class="h1 mb-1 text-center  bg-success" >Income $16,050.30</h1>
                                <div id="dashboardCol1DIV" >

                                </div><!--end dashboardCol1DIV-->
                            </div><!--end dashboardCol1DIV container-->
                            <div class="col border border-danger rounded20 mySection ">
                                <h1 class="h1 mb-1 text-center  bg-danger" >Expenses $5,989</h1>
                                <div id="dashboardCol2DIV" >

                                </div><!--end dashboardCol3DIV-->
                            </div><!--end dashboardCol3DIV container-->
                        </div>
                    </div><!--end DashboardDIV-->
                    <div id="ProjectsDIV" class="col border border-success rounded20 mySection  majorSection ">
                        <h1 class="h1 mb-1 text-center  bg-success" >Active Projects</h1>
                        <div class="row">
                            <div id="projectListDIV" class="col">

                            </div><!--end projectListDIV-->
                            <div id="projectListBarDIV" class="col">
                                <div class="chart-container" style="display:block;margin:0 auto;">
                                    <canvas id="projectListBar" style="height: 100%;width:100%"></canvas>
                                </div>

                            </div><!--end projectListBarDIV-->
                        </div>
                    </div><!--end ProjectsDIV-->
                    <div id="LaborReportsDIV" class="col majorSection " style="display: none">
                        <div class="row" id="LaborReportsRow2DIV">
                            <div class="col border border-success rounded20 mySection">
                                <h1 class="h1 mb-1 text-center  bg-success" >Labor Reports</h1>
                                <div class="border rounded20" id="laborEmployeeCost">
                                </div>
                                <div class="border rounded20" id="laborEmployeeCostbyService">
                                </div>
                                <div class="border rounded20" id="laborLabor">
                                </div>
                            </div><!--end Labor ReportsCol1DIV container-->
                        </div>
                    </div><!--end Labor ReportsDIV-->
                    <div id="TimeDataDIV" class="col majorSection " style="display: none;">
                        <div class="row">
                            <div class="col border border-success rounded20 mySection">
                                <h1 class="h1 mb-1 text-center  bg-success">Time Data</h1>
                                <table class="display table "  id="tbTimeData" style="width:100$">
                                    <thead></thead>
                                    <tfoot>
                                    <tr class="font-weight-bold" ><td >TOTALS:</td><td></td><td></td><td></td><td ></td><td ></td><td ></td></tr>
                                    </tfoot>
                                </table>
                            </div><!--end Time DAta section -->
                        </div>
                    </div>
                    <div id="ProjectTeamDIV" class="col majorSection " style="display: none;">
                        <div class="row">
                            <div class="col border border-success rounded20 mySection">
                                <h1 class="h1 mb-1 text-center  bg-success">Project Team</h1>
                                <table class="display table nowrap" id="tbProjectTeam"  style=" width: auto;">
                                    <thead></thead>
                                </table>
                            </div><!--end Time DAta section -->
                        </div>
                    </div>
                    <div id="BudgetDIV" class="col majorSection " style="display: none;">
                        <div class="row">
                            <div class="col border border-success rounded20 mySection">
                                <h1 class="h1 mb-1 text-center  bg-success">Budget</h1>
                                <table class="display table " id="tbBudget" style="width:100%;font-size:.8rem">
                                    <thead></thead>
                                    <tfoot class="text-white bg-dark "></tfoot>
                                </table>
                            </div><!--end Time DAta section -->
                        </div>
                    </div>
            </td></tr>
        </table>
        </div>

    </div>    <!--end mainDIV-->
</div>

<div class="modal " id="addEmployeeModal" tabindex="-1" role="dialog" aria-labelledby="addEmployeeModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-xl modal-dialog-scrollable" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h1 class="modal-title bg-info w-100" id="addEmployeeHeader"></h1>
            </div>
            <div class="col-lg modal-body">
                <form novalidate   onsubmit="addEmployeeAfter(this)">
                    <div id="addEmployeeMessage"></div>
                    <div class="form-row">
                        <div class="form-group col-sm">
                            <label class="control-label" for="projectTeamDropdownAddEmployee">Project Team</label>
                            <select class="myselect form-control projectTeamDropdown" name="projectTeamDropdown" id="projectTeamDropdownAddEmployee" data-live-search="true" required> </select>
                            <input type="hidden" id="addEmployeeGroup" value="">
                        </div>
                    </div>
                    <div id="addEmpMonths"></div>
                    <div class="form-row"></div>
                    <div class="form-row">
                        <div class="form-group col-sm pt-3">
                            <button type="submit" class="btn btn-primary">Submit</button>
                            <button type="button" class="btn btn-warning" data-dismiss="modal">Cancel</button>
                        </div>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>
</div>
<div class="modal " style="z-index: 9999;" id="messageModal" tabindex="-1" role="dialog" aria-labelledby="messageModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-dialog-scrollable" role="document">
        <div class="modal-content" style="max-height: 90vh">
            <div class="modal-header bg-primary" id="messageHeader">
                <h5 class="modal-title" id="messageTitle"></h5>
            </div>
            <div class="modal-body " id="messageMsg"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="messageOk" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="releaseModal" tabindex="-1" role="dialog" aria-labelledby="releaseModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog" role="document">
        <div class="modal-content" style="max-height: 90vh">
            <div class="modal-header">
                <h2 class="modal-title" id="releaseHeader"></h2>
            </div>
            <div class="modal-body " id="releaseMsg"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="releaseOk" data-dismiss="modal">Ok</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>